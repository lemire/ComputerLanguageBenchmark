<!DOCTYPE html>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="robots" content="noindex,follow,noarchive">

<title>chameneos-redux C++ g++ program | Computer Language Benchmarks Game </title>
<style><!--
a{color:black;text-decoration:none}article{padding: 0 0 2.9em}article,div,footer,header{margin:auto;width:92%}body{font:100% Droid Sans,Ubuntu,Verdana,sans-serif;margin:0;-webkit-text-size-adjust:100%}h1,h2,h3,li a{font-family:Ubuntu Mono,Consolas,Menlo,monospace}div,footer,header{max-width:31em}footer{padding:2.6em 0 0}h1{font-size:1.4em;font-weight:bold;margin:0;padding:.4em}h1,h1 a{color:white}h2,h3{margin:1.5em 0 0}h2{font-size:1.4em;font-weight:normal}h3{font-size:1.2em}li{list-style-type:none;vertical-align:top}li a{display:block;font-size:1.2em;margin:.5em .5em 0;padding:.5em .5em .3em}ul{clear:left;margin:-0.3em 0 1.5em;padding-left:0;text-align:center}p{color:#333;line-height:1.4;margin:.3em 0 0}p a,a span{border-bottom:.1em solid #333;padding-bottom:.1em}#u64,#u64q{background-color:#c90016}#u32{background-color:#ffb515}#u32q{background-color:#ff6309}.com,.slc{color:#888}.kwa{color:#066}.kwb{color:#900}.kwc{color:#050}.kwa,.kwb,.kwc{font-weight:bold}.dstr,.str,.sym,.num{color:#930}pre{color:#222;font-size:1em;overflow-wrap:break-word;white-space:pre-wrap;word-wrap:break-word}@media only screen and (min-width:60em){article,footer,header{font-size:1.25em}}
--></style>
<link rel="shortcut icon" href="./favicon.ico">
<header id="top">
  <h1 id="u64q"><a href="./index.html">The&nbsp;Computer&nbsp;Language<br>Benchmarks&nbsp;Game</a></h1>
</header>
<article>
  <div>
    <h2>chameneos-redux C++ g++ program</h2>
    <aside>
      <p><a href="./chameneosredux-description.html#chameneosredux">description</a>
    </aside>
  </div>
  <section>
    </div>
      <h3>source code</h3>
    </div>
    <pre>
<span class="com">/* The Computer Language Benchmarks Game</span>
<span class="com">http://benchmarksgame.alioth.debian.org/</span>
<span class="com"></span>
<span class="com">Based on original C contribution by Alex Burlyga.</span>
<span class="com">Based on thread pool + request queue in Java contribution by Michael Barker.</span>
<span class="com">Based on single atomic ops, and pthread affinity in C contribution by Dmitry Vyukov.</span>
<span class="com">Based on C++ contribution by Andrew Moon.</span>
<span class="com">Contributed by The Anh Tran.</span>
<span class="com"></span>
<span class="com">This entry creates N kernel threads. All threads will wait inside </span>
<span class="com">boost::asio::io_service queue object. If there is a request posted to io_service </span>
<span class="com">queue, a thread will be dispatched to handle it.</span>
<span class="com"></span>
<span class="com">Each creature will submit &quot;i want to go to meeting place&quot; request to io_service.</span>
<span class="com">Atomic compare-and-set is used to change meeting place state.</span>
<span class="com">*/</span>

<span class="ppc">#include &lt;fstream&gt;</span>
<span class="ppc">#include &lt;iostream&gt;</span>
<span class="ppc">#include &lt;string&gt;</span>
<span class="ppc">#include &lt;map&gt;</span>
<span class="ppc">#include &lt;sstream&gt;</span>

<span class="ppc">#include &lt;cstdlib&gt;</span>
<span class="ppc">#include &lt;cstdio&gt;</span>
<span class="ppc">#include &lt;cassert&gt;</span>
<span class="ppc">#include &lt;cmath&gt;</span>
<span class="ppc">#include &lt;memory.h&gt;</span>

<span class="ppc">#include &lt;pthread.h&gt;</span>
<span class="ppc">#include &lt;sched.h&gt;</span>

<span class="ppc">#include &lt;boost/xpressive/xpressive_static.hpp&gt;</span>
<span class="ppc">#include &lt;boost/lexical_cast.hpp&gt;</span>
<span class="ppc">#include &lt;boost/format.hpp&gt;</span>
<span class="ppc">#include &lt;boost/asio.hpp&gt;</span>
<span class="ppc">#include &lt;boost/thread.hpp&gt;</span>
<span class="ppc">#include &lt;boost/bind.hpp&gt;</span>
<span class="ppc">#include &lt;boost/smart_ptr.hpp&gt;</span>
<span class="ppc">#include &lt;boost/foreach.hpp&gt;</span>

<span class="ppc">#define foreach BOOST_FOREACH</span>



<span class="kwc">typedef</span> <span class="kwb">unsigned int</span> uint<span class="opt">;</span>
<span class="kwc">typedef boost</span><span class="opt">::</span><span class="kwc">asio</span><span class="opt">::</span>io_service QUEUE_T<span class="opt">;</span>


<span class="ppc">#define CPU_INFO_STR</span>   <span class="pps">&quot;/proc/cpuinfo&quot;</span><span class="ppc"></span>
<span class="ppc">#define L2_ALIGN      __attribute__((aligned(16)))</span>

<span class="kwb">enum</span> COLOR <span class="opt">{</span>   BLUE <span class="opt">=</span> <span class="num">0</span><span class="opt">,</span>   RED <span class="opt">=</span> <span class="num">1</span><span class="opt">,</span>   YELLOW <span class="opt">=</span> <span class="num">2</span>   <span class="opt">};</span>
COLOR 
<span class="kwc">operator</span> <span class="opt">^ (</span>COLOR c1<span class="opt">,</span> COLOR c2<span class="opt">)</span>
<span class="opt">{</span>
   <span class="kwa">switch</span> <span class="opt">(</span>c1<span class="opt">)</span>   <span class="slc">// game rule</span>
   <span class="opt">{</span>
   <span class="kwa">case</span> BLUE<span class="opt">:</span>   <span class="kwa">switch</span> <span class="opt">(</span>c2<span class="opt">)</span>
            <span class="opt">{</span>
            <span class="kwa">case</span> BLUE<span class="opt">:</span>      <span class="kwa">return</span> BLUE<span class="opt">;</span>
            <span class="kwa">case</span> RED<span class="opt">:</span>      <span class="kwa">return</span> YELLOW<span class="opt">;</span>
            <span class="kwa">case</span> YELLOW<span class="opt">:</span>   <span class="kwa">return</span> RED<span class="opt">;</span>
            <span class="opt">}</span>

   <span class="kwa">case</span> RED<span class="opt">:</span>   <span class="kwa">switch</span> <span class="opt">(</span>c2<span class="opt">)</span>
            <span class="opt">{</span>
            <span class="kwa">case</span> BLUE<span class="opt">:</span>      <span class="kwa">return</span> YELLOW<span class="opt">;</span>
            <span class="kwa">case</span> RED<span class="opt">:</span>      <span class="kwa">return</span> RED<span class="opt">;</span>
            <span class="kwa">case</span> YELLOW<span class="opt">:</span>   <span class="kwa">return</span> BLUE<span class="opt">;</span>
            <span class="opt">}</span>

   <span class="kwa">case</span> YELLOW<span class="opt">:</span>   <span class="kwa">switch</span> <span class="opt">(</span>c2<span class="opt">)</span>
            <span class="opt">{</span>
            <span class="kwa">case</span> BLUE<span class="opt">:</span>      <span class="kwa">return</span> RED<span class="opt">;</span>
            <span class="kwa">case</span> RED<span class="opt">:</span>      <span class="kwa">return</span> BLUE<span class="opt">;</span>
            <span class="kwa">case</span> YELLOW<span class="opt">:</span>   <span class="kwa">return</span> YELLOW<span class="opt">;</span>
            <span class="opt">}</span>
   <span class="opt">}</span>

   <span class="kwa">assert</span><span class="opt">(</span><span class="kwa">false</span><span class="opt">);</span>
   <span class="kwa">return</span> BLUE<span class="opt">;</span>
<span class="opt">}</span>


<span class="kwc">std</span><span class="opt">::</span>ostream<span class="opt">&amp;</span> 
<span class="kwc">operator</span> <span class="opt">&lt;&lt; (</span><span class="kwc">std</span><span class="opt">::</span>ostream <span class="opt">&amp;</span>os<span class="opt">,</span> COLOR c<span class="opt">)</span> 
<span class="opt">{</span>   
   <span class="kwb">static char const</span> <span class="opt">*</span> ColorName<span class="opt">[</span><span class="num">3</span><span class="opt">]   = {</span><span class="str">&quot;blue&quot;</span><span class="opt">,</span> <span class="str">&quot;red&quot;</span><span class="opt">,</span> <span class="str">&quot;yellow&quot;</span><span class="opt">};</span>
   os <span class="opt">&lt;&lt;</span> ColorName<span class="opt">[</span>c<span class="opt">];</span>
   <span class="kwa">return</span> os<span class="opt">;</span>
<span class="opt">}</span>


<span class="kwc">std</span><span class="opt">::</span>string
<span class="kwd">SpellNumber</span><span class="opt">(</span>uint n<span class="opt">)</span>
<span class="opt">{</span>
   <span class="kwb">static char const</span><span class="opt">*</span> NumberStr<span class="opt">[] =</span> 
   <span class="opt">{</span>
      <span class="str">&quot;zero &quot;</span><span class="opt">,</span> <span class="str">&quot;one &quot;</span><span class="opt">,</span> <span class="str">&quot;two &quot;</span><span class="opt">,</span> <span class="str">&quot;three &quot;</span><span class="opt">,</span> <span class="str">&quot;four &quot;</span><span class="opt">,</span>
      <span class="str">&quot;five &quot;</span><span class="opt">,</span> <span class="str">&quot;six &quot;</span><span class="opt">,</span> <span class="str">&quot;seven &quot;</span><span class="opt">,</span> <span class="str">&quot;eight &quot;</span><span class="opt">,</span> <span class="str">&quot;nine &quot;</span>
   <span class="opt">};</span>
   
   <span class="kwc">std</span><span class="opt">::</span>string num<span class="opt">;</span>
   
   <span class="kwa">while</span> <span class="opt">(</span> n <span class="opt">&gt;=</span> <span class="num">10</span> <span class="opt">)</span>
   <span class="opt">{</span>
      uint m <span class="opt">=</span> n <span class="opt">%</span> <span class="num">10</span><span class="opt">;</span>
      n <span class="opt">/=</span> <span class="num">10</span><span class="opt">;</span>

      num<span class="opt">.</span><span class="kwd">insert</span><span class="opt">(</span><span class="num">0</span><span class="opt">,</span> NumberStr<span class="opt">[</span>m<span class="opt">]);</span>
   <span class="opt">}</span>

   num<span class="opt">.</span><span class="kwd">insert</span><span class="opt">(</span><span class="num">0</span><span class="opt">,</span> NumberStr<span class="opt">[</span>n<span class="opt">]);</span>
   <span class="kwa">return</span> num<span class="opt">;</span>
<span class="opt">}</span>

<span class="com">/*   Place where a creature meet another.</span>
<span class="com">   stage_exchange stores 2 informations:</span>
<span class="com">   _ how many meeting times to go. 28 bit from bit 0 -&gt; 27.</span>
<span class="com">   _ is there any creature waiting. 4 highest bit, 28 -&gt; 31</span>
<span class="com">*/</span>
<span class="kwb">struct</span> MeetingPlace
<span class="opt">{</span>
<span class="kwc">private</span><span class="opt">:</span>
   L2_ALIGN
   uint <span class="kwc">volatile</span>   state_exchange_<span class="opt">;</span>

<span class="kwc">public</span><span class="opt">:</span>
   <span class="kwd">MeetingPlace</span><span class="opt">(</span>uint N<span class="opt">) :</span>   <span class="kwd">state_exchange_</span><span class="opt">(</span>N<span class="opt">)   {   }</span>

<span class="com">/*</span>
<span class="com">   State_exchange = 32 bit</span>
<span class="com">   4 bit MSB: id of creature which is waiting. Can support up to 15 creatures.</span>
<span class="com">   28 bit: counter of how many meeting times that needs to run</span>
<span class="com">*/</span>
   <span class="kwb">int</span> <span class="kwd">EnterMeetingRoom</span><span class="opt">(</span> uint cr_id <span class="opt">)</span>   <span class="slc">// id starts from 1.</span>
   <span class="opt">{</span>
      <span class="kwa">while</span> <span class="opt">(</span><span class="kwa">true</span><span class="opt">)</span>
      <span class="opt">{</span>
         uint old_state <span class="opt">=</span> state_exchange_<span class="opt">;</span>
         uint meeting_left <span class="opt">=</span> old_state <span class="opt">&amp;</span> <span class="num">0x0FFFFFFF</span><span class="opt">;</span>

         <span class="kwa">if</span> <span class="opt">(</span>meeting_left <span class="opt">&gt;</span> <span class="num">0</span><span class="opt">)</span>
         <span class="opt">{</span>
            uint cr_waiting <span class="opt">=</span> old_state <span class="opt">&gt;&gt;</span> <span class="num">28</span><span class="opt">;</span>
            uint new_state<span class="opt">;</span>

            <span class="kwa">if</span> <span class="opt">(</span>cr_waiting <span class="opt">==</span> <span class="num">0</span><span class="opt">)</span>   <span class="slc">// no one inside, me is 1st</span>
               new_state <span class="opt">=</span> meeting_left <span class="opt">| (</span>cr_id <span class="opt">&lt;&lt;</span> <span class="num">28</span><span class="opt">);</span>
            <span class="kwa">else</span>   <span class="slc">// there is a creature waiting</span>
               new_state <span class="opt">=</span> meeting_left <span class="opt">-</span><span class="num">1</span><span class="opt">;</span>

            <span class="kwa">if</span> <span class="opt">(</span><span class="kwd">__sync_bool_compare_and_swap</span><span class="opt">(&amp;</span>state_exchange_<span class="opt">,</span> old_state<span class="opt">,</span> new_state<span class="opt">))</span>
               <span class="kwa">return</span> cr_waiting<span class="opt">;</span>
         <span class="opt">}</span>
         <span class="kwa">else</span>
            <span class="kwa">return</span> <span class="opt">-</span><span class="num">1</span><span class="opt">;</span>
      <span class="opt">}</span>
   <span class="opt">}</span>
<span class="opt">};</span>


<span class="kwb">struct</span> Creature
<span class="opt">{</span>
   QUEUE_T<span class="opt">*</span>            p_queue_<span class="opt">;</span>
   MeetingPlace<span class="opt">*</span>         p_meetingplace_<span class="opt">;</span>
   Creature<span class="opt">*</span>            p_cr_list_<span class="opt">;</span>

   COLOR               color_<span class="opt">;</span>
   uint               count_<span class="opt">;</span>
   uint               id_<span class="opt">;</span>      <span class="slc">// creature id start from 1</span>
   uint               same_count_<span class="opt">;</span>

   <span class="kwd">Creature</span><span class="opt">() :</span> <span class="kwd">color_</span><span class="opt">(</span>BLUE<span class="opt">),</span> <span class="kwd">count_</span><span class="opt">(</span><span class="num">0</span><span class="opt">),</span> <span class="kwd">id_</span><span class="opt">(</span><span class="num">0</span><span class="opt">),</span> <span class="kwd">same_count_</span><span class="opt">(</span><span class="num">0</span><span class="opt">)   {}</span>

   <span class="kwb">void</span> 
   <span class="kwd">Start</span><span class="opt">(</span>   MeetingPlace<span class="opt">*</span> mp<span class="opt">,</span> COLOR color <span class="opt">,</span> uint id<span class="opt">,</span> 
         QUEUE_T<span class="opt">*</span> queue<span class="opt">,</span>  Creature<span class="opt">*</span> pcrl<span class="opt">)</span>
   <span class="opt">{</span>
      color_   <span class="opt">=</span> color<span class="opt">;</span>
      id_      <span class="opt">=</span> id <span class="opt">+</span><span class="num">1</span><span class="opt">;</span>

      p_queue_      <span class="opt">=</span> queue<span class="opt">;</span>
      p_meetingplace_   <span class="opt">=</span> mp<span class="opt">;</span>
      p_cr_list_      <span class="opt">=</span> pcrl<span class="opt">;</span>

      <span class="slc">// post &quot;go to meeting place&quot; request</span>
      p_queue_<span class="opt">-&gt;</span><span class="kwd">post</span><span class="opt">(</span><span class="kwc">boost</span><span class="opt">::</span><span class="kwd">bind</span><span class="opt">(&amp;</span><span class="kwc">Creature</span><span class="opt">::</span>PlayGame<span class="opt">,</span> <span class="kwa">this</span><span class="opt">));</span>
   <span class="opt">}</span>

   <span class="slc">// request granted, meeting action executes here</span>
   <span class="kwb">void</span> 
   <span class="kwd">PlayGame</span><span class="opt">()</span>   
   <span class="opt">{</span>   
      <span class="kwb">int</span> other_cr_id <span class="opt">=</span> p_meetingplace_<span class="opt">-&gt;</span><span class="kwd">EnterMeetingRoom</span><span class="opt">(</span>id_<span class="opt">);</span>

      <span class="slc">// meeting_place returns other creature?</span>
      <span class="kwa">if</span> <span class="opt">(</span>other_cr_id <span class="opt">&gt;</span> <span class="num">0</span><span class="opt">)</span>
         <span class="kwd">SayHello</span><span class="opt">(</span> p_cr_list_<span class="opt">[</span>other_cr_id <span class="opt">-</span><span class="num">1</span><span class="opt">] );</span>

      <span class="slc">// if me is the 1st one entering meeting_place, do nothing. </span>
      <span class="slc">// 2nd arrival creature will submit next meeting request for me.</span>
   <span class="opt">}</span>

   <span class="kwb">void</span> 
   <span class="kwd">SayHello</span><span class="opt">(</span>Creature <span class="opt">&amp;</span>other<span class="opt">)</span>
   <span class="opt">{</span>
      <span class="kwa">if</span> <span class="opt">(</span><span class="kwd">__builtin_expect</span><span class="opt">(</span>id_ <span class="opt">==</span> other<span class="opt">.</span>id_<span class="opt">,</span> <span class="kwa">false</span><span class="opt">))</span>
      <span class="opt">{</span>
         <span class="opt">++</span>same_count_<span class="opt">;</span>
         <span class="opt">++</span>other<span class="opt">.</span>same_count_<span class="opt">;</span>
      <span class="opt">}</span>
      
      <span class="opt">++</span>count_<span class="opt">;</span>
      <span class="opt">++</span>other<span class="opt">.</span>count_<span class="opt">;</span>

      COLOR new_color   <span class="opt">=</span> <span class="kwa">this</span><span class="opt">-&gt;</span>color_ <span class="opt">^</span> other<span class="opt">.</span>color_<span class="opt">;</span>
      other<span class="opt">.</span>color_   <span class="opt">=</span> color_   <span class="opt">=</span> new_color<span class="opt">;</span>

      <span class="slc">// submit another meeting request, for current creature + other creature.</span>
      p_queue_<span class="opt">-&gt;</span><span class="kwd">post</span><span class="opt">(</span><span class="kwc">boost</span><span class="opt">::</span><span class="kwd">bind</span><span class="opt">(&amp;</span><span class="kwc">Creature</span><span class="opt">::</span>PlayGame<span class="opt">,</span> <span class="kwa">this</span><span class="opt">));</span>
      p_queue_<span class="opt">-&gt;</span><span class="kwd">post</span><span class="opt">(</span><span class="kwc">boost</span><span class="opt">::</span><span class="kwd">bind</span><span class="opt">(&amp;</span><span class="kwc">Creature</span><span class="opt">::</span>PlayGame<span class="opt">, &amp;</span>other<span class="opt">));</span>
   <span class="opt">}</span>
<span class="opt">}</span> L2_ALIGN<span class="opt">;</span>



<span class="kwc">template</span> <span class="opt">&lt;</span><span class="kwb">int</span> ncolor<span class="opt">&gt;</span>
<span class="kwb">struct</span> Game
<span class="opt">{</span>
   MeetingPlace   mplace<span class="opt">;</span>
   QUEUE_T         queue<span class="opt">;</span>
   Creature      cr_list<span class="opt">[</span>ncolor<span class="opt">];</span>   <span class="slc">// list of all creatures</span>

   <span class="kwc">std</span><span class="opt">::</span>ostringstream   game_output<span class="opt">;</span>
   <span class="kwc">boost</span><span class="opt">::</span>thread_group   cr_thread_group<span class="opt">;</span>         <span class="slc">// 1 standard OS thread for each creature</span>

   <span class="kwd">Game</span><span class="opt">(</span>uint n<span class="opt">,</span> COLOR <span class="kwb">const</span> <span class="opt">(&amp;</span>color<span class="opt">)[</span>ncolor<span class="opt">],</span> cpu_set_t <span class="opt">*</span> aff <span class="opt">=</span> <span class="num">0</span><span class="opt">)</span>   
      <span class="opt">:</span>   <span class="kwd">mplace</span><span class="opt">(</span>n<span class="opt">)</span>   
   <span class="opt">{</span>
      <span class="kwc">boost</span><span class="opt">::</span>format <span class="kwd">fmt</span><span class="opt">(</span><span class="str">&quot;%1% &quot;</span><span class="opt">);</span>
      
      <span class="slc">// print initial color of each creature</span>
      <span class="kwa">for</span> <span class="opt">(</span><span class="kwb">int</span> i <span class="opt">=</span> <span class="num">0</span><span class="opt">;</span> i <span class="opt">&lt;</span> ncolor<span class="opt">; ++</span>i<span class="opt">)</span>
      <span class="opt">{</span>
         game_output <span class="opt">&lt;&lt; (</span>fmt <span class="opt">% (</span>color<span class="opt">[</span>i<span class="opt">]) );</span>
         cr_list<span class="opt">[</span>i<span class="opt">].</span><span class="kwd">Start</span><span class="opt">( &amp;</span>mplace<span class="opt">,</span> color<span class="opt">[</span>i<span class="opt">],</span> i<span class="opt">, &amp;</span>queue<span class="opt">,</span> cr_list <span class="opt">);</span>
      <span class="opt">}</span>
      game_output <span class="opt">&lt;&lt;</span> <span class="kwc">std</span><span class="opt">::</span>endl<span class="opt">;</span>

      <span class="slc">// Create N kernel threads. All threads will wait inside boost::asio::io_service</span>
      <span class="slc">// queue object. If there is a request posted to io_service queue, a thread</span>
      <span class="slc">// will be dispatched to handle it.</span>
      <span class="kwa">for</span> <span class="opt">(</span><span class="kwb">int</span> i <span class="opt">=</span> <span class="num">0</span><span class="opt">;</span> i <span class="opt">&lt;</span> ncolor<span class="opt">; ++</span>i<span class="opt">)</span>
      <span class="opt">{</span>
         <span class="kwc">boost</span><span class="opt">::</span>thread<span class="opt">*</span> t <span class="opt">=</span> cr_thread_group<span class="opt">.</span><span class="kwd">create_thread</span><span class="opt">(</span><span class="kwc">boost</span><span class="opt">::</span><span class="kwd">bind</span><span class="opt">(&amp;</span><span class="kwc">QUEUE_T</span><span class="opt">::</span>run<span class="opt">, &amp;</span>queue<span class="opt">));</span>
      
         <span class="kwa">if</span><span class="opt">(</span>aff <span class="opt">!=</span> <span class="num">0</span><span class="opt">)</span>
            <span class="kwd">pthread_setaffinity_np</span><span class="opt">(</span>t<span class="opt">-&gt;</span><span class="kwd">native_handle</span><span class="opt">(),</span> <span class="kwa">sizeof</span><span class="opt">(</span>cpu_set_t<span class="opt">),</span> aff<span class="opt">);</span>
      <span class="opt">}</span>
   <span class="opt">}</span>

   <span class="kwc">std</span><span class="opt">::</span>string
   <span class="kwd">WaitAndGetResult</span><span class="opt">()</span>
   <span class="opt">{</span>
      <span class="slc">// wait until meeting times = 0</span>
      cr_thread_group<span class="opt">.</span><span class="kwd">join_all</span><span class="opt">();</span>

      uint total <span class="opt">=</span> <span class="num">0</span><span class="opt">;</span>
      <span class="kwc">boost</span><span class="opt">::</span>format <span class="kwd">fmt</span><span class="opt">(</span><span class="str">&quot;%1% %2%</span><span class="esc">\n</span><span class="str">&quot;</span><span class="opt">);</span>

      <span class="slc">// print meeting times of each creature</span>
      <span class="kwa">for</span> <span class="opt">(</span><span class="kwb">int</span> i <span class="opt">=</span> <span class="num">0</span><span class="opt">;</span> i <span class="opt">&lt;</span> ncolor<span class="opt">;</span> i<span class="opt">++)</span>
      <span class="opt">{</span>
         total <span class="opt">+=</span> cr_list<span class="opt">[</span>i<span class="opt">].</span>count_<span class="opt">;</span>
         game_output <span class="opt">&lt;&lt; (</span>fmt 
                     <span class="opt">%</span> cr_list<span class="opt">[</span>i<span class="opt">].</span>count_ 
                     <span class="opt">%</span> <span class="kwd">SpellNumber</span><span class="opt">(</span>cr_list<span class="opt">[</span>i<span class="opt">].</span>same_count_<span class="opt">)   );</span>
      <span class="opt">}</span>

      <span class="slc">// print total meeting times</span>
      fmt <span class="opt">=</span> <span class="kwc">boost</span><span class="opt">::</span><span class="kwd">format</span><span class="opt">(</span><span class="str">&quot; %1%</span><span class="esc">\n\n</span><span class="str">&quot;</span><span class="opt">);</span>
      game_output <span class="opt">&lt;&lt; (</span>fmt <span class="opt">%</span> <span class="kwd">SpellNumber</span><span class="opt">(</span>total<span class="opt">));</span>

      <span class="kwa">return</span> game_output<span class="opt">.</span><span class="kwd">str</span><span class="opt">();</span>
   <span class="opt">}</span>
<span class="opt">};</span>

<span class="kwb">void</span> 
<span class="kwd">PrintColors</span><span class="opt">()</span>
<span class="opt">{</span>
   <span class="kwc">boost</span><span class="opt">::</span>format <span class="kwd">fmt</span><span class="opt">(</span><span class="str">&quot;%1% + %2% -&gt; %3%</span><span class="esc">\n</span><span class="str">&quot;</span><span class="opt">);</span>
   
   <span class="kwa">for</span> <span class="opt">(</span><span class="kwb">int</span> c1 <span class="opt">=</span> BLUE<span class="opt">;</span> c1 <span class="opt">&lt;=</span> YELLOW<span class="opt">; ++</span>c1<span class="opt">)</span>
   <span class="opt">{</span>
      <span class="kwa">for</span> <span class="opt">(</span><span class="kwb">int</span> c2 <span class="opt">=</span> BLUE<span class="opt">;</span> c2 <span class="opt">&lt;=</span> YELLOW<span class="opt">; ++</span>c2<span class="opt">)</span>
         <span class="kwc">std</span><span class="opt">::</span>cout <span class="opt">&lt;&lt; (</span>fmt <span class="opt">% (</span>COLOR<span class="opt">)</span>c1 <span class="opt">% (</span>COLOR<span class="opt">)</span>c2 <span class="opt">% ((</span>COLOR<span class="opt">)</span>c1 <span class="opt">^ (</span>COLOR<span class="opt">)</span>c2<span class="opt">));</span>
   <span class="opt">}</span>

   <span class="kwc">std</span><span class="opt">::</span>cout <span class="opt">&lt;&lt;</span> <span class="kwc">std</span><span class="opt">::</span>endl<span class="opt">;</span>
<span class="opt">}</span>

<span class="slc">// Detect multi / single thread benchmark</span>
<span class="kwb">int</span> 
<span class="kwd">GetThreadCount</span><span class="opt">()</span>
<span class="opt">{</span>
   cpu_set_t cs<span class="opt">;</span>
   <span class="kwd">CPU_ZERO</span><span class="opt">(&amp;</span>cs<span class="opt">);</span>
   <span class="kwd">sched_getaffinity</span><span class="opt">(</span><span class="num">0</span><span class="opt">,</span> <span class="kwa">sizeof</span><span class="opt">(</span>cs<span class="opt">), &amp;</span>cs<span class="opt">);</span>

   <span class="kwb">int</span> count <span class="opt">=</span> <span class="num">0</span><span class="opt">;</span>
   <span class="kwa">for</span> <span class="opt">(</span><span class="kwb">int</span> i <span class="opt">=</span> <span class="num">0</span><span class="opt">;</span> i <span class="opt">&lt;</span> <span class="num">16</span><span class="opt">; ++</span>i<span class="opt">)</span>
   <span class="opt">{</span>
      <span class="kwa">if</span> <span class="opt">(</span><span class="kwd">CPU_ISSET</span><span class="opt">(</span>i<span class="opt">, &amp;</span>cs<span class="opt">))</span>
         <span class="opt">++</span>count<span class="opt">;</span>
   <span class="opt">}</span>
   <span class="kwa">return</span> count<span class="opt">;</span>
<span class="opt">}</span>

<span class="slc">// Parse /proc/cpuinfo</span>
<span class="slc">// Return a list of cpu cores sharing 1 L2 cache</span>
<span class="kwc">std</span><span class="opt">::</span>auto_ptr<span class="opt">&lt;</span><span class="kwc">std</span><span class="opt">::</span>vector<span class="opt">&lt;</span>cpu_set_t<span class="opt">&gt; &gt;</span>
<span class="kwd">GetAffinityList</span><span class="opt">()</span>
<span class="opt">{</span>
   <span class="kwc">std</span><span class="opt">::</span>ifstream <span class="kwd">file</span><span class="opt">(</span>CPU_INFO_STR<span class="opt">);</span>
   <span class="kwc">std</span><span class="opt">::</span>istreambuf_iterator<span class="opt">&lt;</span><span class="kwb">char</span><span class="opt">&gt;</span> <span class="kwd">is</span><span class="opt">(</span>file<span class="opt">),</span> ise<span class="opt">;</span>

   <span class="slc">// load file to vector&lt;char&gt;</span>
   <span class="kwc">std</span><span class="opt">::</span>vector<span class="opt">&lt;</span><span class="kwb">char</span><span class="opt">&gt;</span> buf<span class="opt">;</span>
   <span class="kwc">std</span><span class="opt">::</span><span class="kwd">copy</span><span class="opt">(</span>is<span class="opt">,</span> ise<span class="opt">,</span> <span class="kwc">std</span><span class="opt">::</span><span class="kwd">back_inserter</span><span class="opt">(</span>buf<span class="opt">));</span>
   file<span class="opt">.</span><span class="kwd">close</span><span class="opt">();</span>
   

   <span class="slc">// map processors to L2 cache unit</span>
   <span class="kwc">typedef std</span><span class="opt">::</span>map<span class="opt">&lt;</span><span class="kwb">int</span><span class="opt">,</span> cpu_set_t<span class="opt">&gt;</span> MAP_T<span class="opt">;</span>
   MAP_T l2_set<span class="opt">;</span>

   <span class="opt">{</span>
      <span class="kwa">using namespace</span> <span class="kwc">boost</span><span class="opt">::</span>xpressive<span class="opt">;</span>
      <span class="kwa">namespace</span> bx <span class="opt">=</span> <span class="kwc">boost</span><span class="opt">::</span>xpressive<span class="opt">;</span>

      <span class="kwc">typedef std</span><span class="opt">::</span>vector<span class="opt">&lt;</span><span class="kwb">char</span><span class="opt">&gt;::</span>iterator      VI_T<span class="opt">;</span>
      <span class="kwc">typedef bx</span><span class="opt">::</span>basic_regex<span class="opt">&lt;</span>VI_T<span class="opt">&gt;</span>         RE_T<span class="opt">;</span>
      <span class="kwc">typedef bx</span><span class="opt">::</span>regex_iterator<span class="opt">&lt;</span>VI_T<span class="opt">&gt;</span>      IRE_T<span class="opt">;</span>

      RE_T <span class="kwd">re</span><span class="opt">(</span>
         <span class="kwd">as_xpr</span><span class="opt">(</span><span class="str">&quot;processor&quot;</span><span class="opt">) &gt;&gt; +(</span>_s<span class="opt">|</span><span class="str">&apos;:&apos;</span><span class="opt">) &gt;&gt; (</span>s1 <span class="opt">= +</span>_d<span class="opt">)</span>
         <span class="opt">&gt;&gt; -+(~</span>_n<span class="opt">|</span>_n<span class="opt">)</span>
         <span class="opt">&gt;&gt;</span> <span class="str">&quot;apicid&quot;</span> <span class="opt">&gt;&gt; +(</span>_s<span class="opt">|</span><span class="str">&apos;:&apos;</span><span class="opt">) &gt;&gt; (</span>s2 <span class="opt">= +</span>_d<span class="opt">) );</span>

      IRE_T <span class="kwd">it</span><span class="opt">(</span>buf<span class="opt">.</span><span class="kwd">begin</span><span class="opt">(),</span> buf<span class="opt">.</span><span class="kwd">end</span><span class="opt">(),</span> re<span class="opt">),</span> it_end<span class="opt">;</span>

      <span class="kwa">for</span> <span class="opt">(;</span> it <span class="opt">!=</span> it_end<span class="opt">; ++</span>it<span class="opt">)</span>
      <span class="opt">{</span>
         <span class="kwb">int</span> core <span class="opt">=</span> <span class="kwc">boost</span><span class="opt">::</span>lexical_cast<span class="opt">&lt;</span><span class="kwb">int</span><span class="opt">&gt;( (*</span>it<span class="opt">)[</span><span class="num">1</span><span class="opt">].</span><span class="kwd">str</span><span class="opt">() );</span>
         <span class="kwb">int</span> apic <span class="opt">=</span> <span class="kwc">boost</span><span class="opt">::</span>lexical_cast<span class="opt">&lt;</span><span class="kwb">int</span><span class="opt">&gt;( (*</span>it<span class="opt">)[</span><span class="num">2</span><span class="opt">].</span><span class="kwd">str</span><span class="opt">() );</span>
         
         <span class="slc">// q6600 has 4 cores, 2 cores share 1 L2 cache</span>
         <span class="slc">// 2 cores + 1 L2 = 1 package</span>
         <span class="kwb">int</span> package <span class="opt">=</span> apic <span class="opt">&gt;&gt;</span> <span class="num">1</span><span class="opt">;</span>

         <span class="kwd">CPU_SET</span><span class="opt">(</span>core<span class="opt">, &amp;(</span>l2_set<span class="opt">[</span>package<span class="opt">]));</span>
      <span class="opt">}</span>
   <span class="opt">}</span>

   <span class="kwc">std</span><span class="opt">::</span>auto_ptr<span class="opt">&lt;</span><span class="kwc">std</span><span class="opt">::</span>vector<span class="opt">&lt;</span>cpu_set_t<span class="opt">&gt; &gt;</span> <span class="kwd">aff</span><span class="opt">(</span><span class="kwa">new</span> <span class="kwc">std</span><span class="opt">::</span>vector<span class="opt">&lt;</span>cpu_set_t<span class="opt">&gt;);</span>
   <span class="kwc">typedef MAP_T</span><span class="opt">::</span>value_type VT<span class="opt">;</span>

   <span class="kwd">foreach</span> <span class="opt">(</span> VT <span class="opt">&amp;</span>i<span class="opt">,</span> l2_set <span class="opt">)</span>
      aff<span class="opt">-&gt;</span><span class="kwd">push_back</span><span class="opt">(</span>i<span class="opt">.</span>second<span class="opt">);</span>

   <span class="kwa">return</span> aff<span class="opt">;</span>
<span class="opt">}</span>


<span class="kwb">int</span> 
<span class="kwd">main</span><span class="opt">(</span><span class="kwb">int</span> argc<span class="opt">,</span> <span class="kwb">char</span><span class="opt">**</span> argv<span class="opt">)</span>
<span class="opt">{</span>
   <span class="kwd">PrintColors</span><span class="opt">();</span>

   COLOR <span class="kwb">const</span> r1<span class="opt">[] = {</span>   BLUE<span class="opt">,</span> RED<span class="opt">,</span> YELLOW   <span class="opt">};</span>
   COLOR <span class="kwb">const</span> r2<span class="opt">[] = {</span>   BLUE<span class="opt">,</span> RED<span class="opt">,</span> YELLOW<span class="opt">,</span> RED<span class="opt">,</span> YELLOW<span class="opt">,</span> BLUE<span class="opt">,</span> RED<span class="opt">,</span> YELLOW<span class="opt">,</span> RED<span class="opt">,</span> BLUE   <span class="opt">};</span>
   
   <span class="kwb">int</span> n <span class="opt">= (</span>argc <span class="opt">&gt;=</span> <span class="num">2</span><span class="opt">) ?</span> <span class="kwc">boost</span><span class="opt">::</span>lexical_cast<span class="opt">&lt;</span><span class="kwb">int</span><span class="opt">&gt;(</span>argv<span class="opt">[</span><span class="num">1</span><span class="opt">]) :</span> <span class="num">600</span><span class="opt">;</span>
   
   <span class="kwa">if</span> <span class="opt">(</span><span class="kwd">GetThreadCount</span><span class="opt">() &gt;</span> <span class="num">1</span><span class="opt">)</span>
   <span class="opt">{</span>
      <span class="kwc">std</span><span class="opt">::</span>auto_ptr<span class="opt">&lt;</span><span class="kwc">std</span><span class="opt">::</span>vector<span class="opt">&lt;</span>cpu_set_t<span class="opt">&gt; &gt;</span> <span class="kwd">affset</span><span class="opt">(</span> <span class="kwd">GetAffinityList</span><span class="opt">() );</span>

      Game<span class="opt">&lt;</span><span class="num">3</span><span class="opt">&gt;</span> <span class="kwd">cg1</span><span class="opt">(</span> n<span class="opt">,</span> r1<span class="opt">, &amp;((*</span>affset<span class="opt">)[</span><span class="num">0</span><span class="opt">]) );</span>
      Game<span class="opt">&lt;</span><span class="num">10</span><span class="opt">&gt;</span> <span class="kwd">cg2</span><span class="opt">(</span> n<span class="opt">,</span> r2<span class="opt">, &amp;((*</span>affset<span class="opt">)[</span><span class="num">1</span><span class="opt">]) );</span>
      
      <span class="kwc">std</span><span class="opt">::</span>cout <span class="opt">&lt;&lt;</span> cg1<span class="opt">.</span><span class="kwd">WaitAndGetResult</span><span class="opt">();</span>
      <span class="kwc">std</span><span class="opt">::</span>cout <span class="opt">&lt;&lt;</span> cg2<span class="opt">.</span><span class="kwd">WaitAndGetResult</span><span class="opt">();</span>
   <span class="opt">}</span>
   <span class="kwa">else</span>
   <span class="opt">{</span>
      Game<span class="opt">&lt;</span><span class="num">3</span><span class="opt">&gt;</span> <span class="kwd">cg1</span><span class="opt">(</span> n<span class="opt">,</span> r1 <span class="opt">);</span>
      <span class="kwc">std</span><span class="opt">::</span>cout <span class="opt">&lt;&lt;</span> cg1<span class="opt">.</span><span class="kwd">WaitAndGetResult</span><span class="opt">();</span>

      Game<span class="opt">&lt;</span><span class="num">10</span><span class="opt">&gt;</span> <span class="kwd">cg2</span><span class="opt">(</span> n<span class="opt">,</span> r2 <span class="opt">);</span>
      <span class="kwc">std</span><span class="opt">::</span>cout <span class="opt">&lt;&lt;</span> cg2<span class="opt">.</span><span class="kwd">WaitAndGetResult</span><span class="opt">();</span>
   <span class="opt">}</span>

   <span class="kwa">return</span> <span class="num">0</span><span class="opt">;</span>
<span class="opt">}</span>
    </pre>
  </section>
  <section>
    <h3 id="log">notes, command-line, and program output</h3>
    <pre>
NOTES:
64-bit Ubuntu quad core
g++ (Ubuntu 7.2.0-8ubuntu3) 7.2.0


Mon, 30 Oct 2017 18:49:54 GMT

MAKE:
/usr/bin/g++ -c -pipe -O3 -fomit-frame-pointer -march=native  -pthread chameneosredux.c++ -o chameneosredux.c++.o &amp;&amp;  \
        /usr/bin/g++ chameneosredux.c++.o -o chameneosredux.gpp_run -lboost_thread -lboost_system -lpthread 
chameneosredux.c++:323:6: warning: ‘template&lt;class&gt; class std::auto_ptr’ is deprecated [-Wdeprecated-declarations]
 std::auto_ptr&lt;std::vector&lt;cpu_set_t&gt; &gt;
      ^~~~~~~~
In file included from /usr/include/c++/7/memory:80:0,
                 from /usr/include/boost/config/no_tr1/memory.hpp:21,
                 from /usr/include/boost/smart_ptr/shared_ptr.hpp:23,
                 from /usr/include/boost/shared_ptr.hpp:17,
                 from /usr/include/boost/xpressive/detail/detail_fwd.hpp:23,
                 from /usr/include/boost/xpressive/regex_primitives.hpp:21,
                 from /usr/include/boost/xpressive/xpressive_static.hpp:24,
                 from chameneosredux.c++:33:
/usr/include/c++/7/bits/unique_ptr.h:51:28: note: declared here
   template&lt;typename&gt; class auto_ptr;
                            ^~~~~~~~
chameneosredux.c++: In function ‘std::auto_ptr&lt;std::vector&lt;cpu_set_t&gt; &gt; GetAffinityList()’:
chameneosredux.c++:367:9: warning: ‘template&lt;class&gt; class std::auto_ptr’ is deprecated [-Wdeprecated-declarations]
    std::auto_ptr&lt;std::vector&lt;cpu_set_t&gt; &gt; aff(new std::vector&lt;cpu_set_t&gt;);
         ^~~~~~~~
In file included from /usr/include/c++/7/memory:80:0,
                 from /usr/include/boost/config/no_tr1/memory.hpp:21,
                 from /usr/include/boost/smart_ptr/shared_ptr.hpp:23,
                 from /usr/include/boost/shared_ptr.hpp:17,
                 from /usr/include/boost/xpressive/detail/detail_fwd.hpp:23,
                 from /usr/include/boost/xpressive/regex_primitives.hpp:21,
                 from /usr/include/boost/xpressive/xpressive_static.hpp:24,
                 from chameneosredux.c++:33:
/usr/include/c++/7/bits/unique_ptr.h:51:28: note: declared here
   template&lt;typename&gt; class auto_ptr;
                            ^~~~~~~~
chameneosredux.c++: In function ‘int main(int, char**)’:
chameneosredux.c++:389:12: warning: ‘template&lt;class&gt; class std::auto_ptr’ is deprecated [-Wdeprecated-declarations]
       std::auto_ptr&lt;std::vector&lt;cpu_set_t&gt; &gt; affset( GetAffinityList() );
            ^~~~~~~~
In file included from /usr/include/c++/7/memory:80:0,
                 from /usr/include/boost/config/no_tr1/memory.hpp:21,
                 from /usr/include/boost/smart_ptr/shared_ptr.hpp:23,
                 from /usr/include/boost/shared_ptr.hpp:17,
                 from /usr/include/boost/xpressive/detail/detail_fwd.hpp:23,
                 from /usr/include/boost/xpressive/regex_primitives.hpp:21,
                 from /usr/include/boost/xpressive/xpressive_static.hpp:24,
                 from chameneosredux.c++:33:
/usr/include/c++/7/bits/unique_ptr.h:51:28: note: declared here
   template&lt;typename&gt; class auto_ptr;
                            ^~~~~~~~
rm chameneosredux.c++

14.99s to complete and log all make actions

COMMAND LINE:
./chameneosredux.gpp_run 6000000

PROGRAM OUTPUT:
blue + blue -&gt; blue
blue + red -&gt; yellow
blue + yellow -&gt; red
red + blue -&gt; yellow
red + red -&gt; red
red + yellow -&gt; blue
yellow + blue -&gt; red
yellow + red -&gt; blue
yellow + yellow -&gt; yellow

blue red yellow 
4014022 zero 
3972724 zero 
4013254 zero 
 one two zero zero zero zero zero zero 

blue red yellow red yellow blue red yellow red blue 
1246228 zero 
1197984 zero 
1285528 zero 
1229433 zero 
1181656 zero 
1094422 zero 
1208217 zero 
1186895 zero 
1186909 zero 
1182728 zero 
 one two zero zero zero zero zero zero 

    </pre>
  </section>
</article>
<footer>
  <nav>
    <ul>
      <li><a href="./license.html"><span>license</span></a>
    </ul>
  </nav>
</footer>

