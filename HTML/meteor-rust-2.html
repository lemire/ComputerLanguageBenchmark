<!DOCTYPE html>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="robots" content="noindex,follow,noarchive">

<title>meteor-contest Rust&nbsp;#2 program | Computer Language Benchmarks Game </title>
<style><!--
a{color:black;text-decoration:none}article{padding: 0 0 2.9em}article,div,footer,header{margin:auto;width:92%}body{font:100% Droid Sans,Ubuntu,Verdana,sans-serif;margin:0;-webkit-text-size-adjust:100%}h1,h2,h3,li a{font-family:Ubuntu Mono,Consolas,Menlo,monospace}div,footer,header{max-width:31em}footer{padding:2.6em 0 0}h1{font-size:1.4em;font-weight:bold;margin:0;padding:.4em}h1,h1 a{color:white}h2,h3{margin:1.5em 0 0}h2{font-size:1.4em;font-weight:normal}h3{font-size:1.2em}li{list-style-type:none;vertical-align:top}li a{display:block;font-size:1.2em;margin:.5em .5em 0;padding:.5em .5em .3em}ul{clear:left;margin:-0.3em 0 1.5em;padding-left:0;text-align:center}p{color:#333;line-height:1.4;margin:.3em 0 0}p a,a span{border-bottom:.1em solid #333;padding-bottom:.1em}#u64,#u64q{background-color:#c90016}#u32{background-color:#ffb515}#u32q{background-color:#ff6309}.com,.slc{color:#888}.kwa{color:#066}.kwb{color:#900}.kwc{color:#050}.kwa,.kwb,.kwc{font-weight:bold}.dstr,.str,.sym,.num{color:#930}pre{color:#222;font-size:1em;overflow-wrap:break-word;white-space:pre-wrap;word-wrap:break-word}@media only screen and (min-width:60em){article,footer,header{font-size:1.25em}}
--></style>
<link rel="shortcut icon" href="./favicon.ico">
<header id="top">
  <h1 id="u64q"><a href="./index.html">The&nbsp;Computer&nbsp;Language<br>Benchmarks&nbsp;Game</a></h1>
</header>
<article>
  <div>
    <h2>meteor-contest Rust&nbsp;#2 program</h2>
    <aside>
      <p><a href="./meteor-description.html#meteor">description</a>
    </aside>
  </div>
  <section>
    </div>
      <h3>source code</h3>
    </div>
    <pre>
<span class="com">/* The Computer Language Benchmarks Game</span>
<span class="com">   http://benchmarksgame.alioth.debian.org/</span>
<span class="com">   contributed by Olof Kraigher</span>
<span class="com"></span>
<span class="com">   Tested with rust 1.0.0-beta</span>
<span class="com">   Compile with: rustc -C opt-level=3 meteor.rs -o meteor</span>
<span class="com">*/</span>

<span class="kwa">use</span> std<span class="opt">::</span>sync<span class="opt">::</span>Arc<span class="opt">;</span>
<span class="kwa">use</span> std<span class="opt">::</span>sync<span class="opt">::</span>mpsc<span class="opt">::{</span>Sender<span class="opt">,</span> Receiver<span class="opt">,</span> channel<span class="opt">};</span>
<span class="kwa">use</span> std<span class="opt">::</span>thread<span class="opt">::</span>spawn<span class="opt">;</span>
<span class="kwa">use</span> std<span class="opt">::</span>cmp<span class="opt">::</span>Ordering<span class="opt">;</span>


<span class="kwa">fn</span> <span class="kwd">main</span> <span class="opt">() {</span>
    <span class="kwa">match</span> <span class="kwd">read_args</span><span class="opt">() {</span>
        <span class="kwd">Ok</span><span class="opt">(</span>num_solutions<span class="opt">) =&gt; {</span>
            <span class="kwd">solve</span><span class="opt">(</span>num_solutions<span class="opt">);</span>
        <span class="opt">}</span>
        <span class="kwd">Err</span><span class="opt">(</span>message<span class="opt">) =&gt; {</span>
            println<span class="opt">!(</span><span class="str">&quot;{}&quot;</span><span class="opt">,</span> message<span class="opt">);</span>
            std<span class="opt">::</span>process<span class="opt">::</span><span class="kwd">exit</span><span class="opt">(</span><span class="num">1</span><span class="opt">);</span>
        <span class="opt">}</span>
    <span class="opt">}</span>
<span class="opt">}</span>

<span class="kwa">fn</span> <span class="kwd">solve</span><span class="opt">(</span>num_solutions <span class="opt">:</span> <span class="kwb">usize</span><span class="opt">) {</span>
    <span class="kwa">let</span> <span class="opt">(</span>min<span class="opt">,</span> max<span class="opt">,</span> num_found<span class="opt">) =</span> <span class="kwd">read_solutions</span><span class="opt">(</span><span class="kwd">spawn_solvers</span><span class="opt">(),</span> num_solutions<span class="opt">);</span>
    println<span class="opt">!(</span><span class="str">&quot;{} solutions found</span><span class="esc">\</span><span class="str">n&quot;</span><span class="opt">,</span> num_found<span class="opt">);</span>
    min<span class="opt">.</span><span class="kwd">pretty_print</span><span class="opt">();</span>
    max<span class="opt">.</span><span class="kwd">pretty_print</span><span class="opt">();</span>
<span class="opt">}</span>

<span class="kwa">fn</span> <span class="kwd">read_args</span><span class="opt">() -&gt;</span> Result<span class="opt">&lt;</span><span class="kwb">usize</span><span class="opt">,</span> String<span class="opt">&gt; {</span>
    <span class="kwa">let</span> args <span class="opt">:</span> Vec<span class="opt">&lt;</span>String<span class="opt">&gt; =</span> std<span class="opt">::</span>env<span class="opt">::</span><span class="kwd">args</span><span class="opt">().</span><span class="kwd">collect</span><span class="opt">();</span>
    <span class="kwa">if</span> args<span class="opt">.</span><span class="kwd">len</span><span class="opt">() !=</span> <span class="num">2</span> <span class="opt">{</span>
        <span class="kwa">return</span> <span class="kwd">Err</span><span class="opt">(</span>format<span class="opt">!(</span>
            <span class="str">&quot;Usage: {} num_solutions&quot;</span><span class="opt">,</span>
            args<span class="opt">[</span><span class="num">0</span><span class="opt">]));</span>
    <span class="opt">}</span>

    <span class="kwa">let</span> maybe_int <span class="opt">:</span> Result<span class="opt">&lt;</span><span class="kwb">usize</span><span class="opt">,</span> _<span class="opt">&gt; =</span> args<span class="opt">[</span><span class="num">1</span><span class="opt">].</span><span class="kwd">parse</span><span class="opt">();</span>
    <span class="kwa">if</span> <span class="opt">!</span>maybe_int<span class="num">.i</span>s<span class="num">_</span>ok<span class="opt">() {</span>
        <span class="kwa">return</span> <span class="kwd">Err</span><span class="opt">(</span>format<span class="opt">!(</span>
            <span class="str">&quot;Invalid argument &apos;{}&apos; cannot parse as unsigned integer&quot;</span><span class="opt">,</span>
            args<span class="opt">[</span><span class="num">1</span><span class="opt">]));</span>
    <span class="opt">}</span>

    <span class="kwa">let</span> num_solutions <span class="opt">=</span> maybe_int<span class="num">.u</span>nwrap<span class="opt">();</span>
    <span class="kwa">if</span> num_solutions <span class="opt">==</span> <span class="num">0</span> <span class="opt">{</span>
        <span class="kwa">return</span> <span class="kwd">Err</span><span class="opt">(</span>format<span class="opt">!(</span>
            <span class="str">&quot;Invalid argument &apos;{}&apos; must be greather than 0&quot;</span><span class="opt">,</span>
            args<span class="opt">[</span><span class="num">1</span><span class="opt">]));</span>
    <span class="opt">}</span>

    <span class="kwa">return</span> <span class="kwd">Ok</span><span class="opt">(</span>num_solutions<span class="opt">);</span>
<span class="opt">}</span>

<span class="kwa">fn</span> <span class="kwd">read_solutions</span><span class="opt">(</span>solution_receiver <span class="opt">:</span> Receiver<span class="opt">&lt;</span>Solution<span class="opt">&gt;,</span>
                  num_solutions <span class="opt">:</span> <span class="kwb">usize</span><span class="opt">)  -&gt; (</span>Solution<span class="opt">,</span> Solution<span class="opt">,</span> <span class="kwb">usize</span><span class="opt">) {</span>
    <span class="kwa">let</span> first <span class="opt">=</span> solution_receiver<span class="opt">.</span><span class="kwd">recv</span><span class="opt">()</span><span class="num">.u</span>nwrap<span class="opt">();</span>
    <span class="kwa">let mut</span> num_found <span class="opt">=</span> <span class="num">1</span><span class="opt">;</span>
    <span class="kwa">let mut</span> min <span class="opt">=</span> first<span class="opt">.</span><span class="kwd">clone</span><span class="opt">();</span>
    <span class="kwa">let mut</span> max <span class="opt">=</span> first<span class="opt">;</span>
    <span class="kwa">for</span> solution <span class="kwa">in</span> solution_receiver<span class="num">.i</span>ter<span class="opt">() {</span>
        <span class="kwa">if</span> num_found <span class="opt">==</span> num_solutions <span class="opt">{</span>
            <span class="kwa">break</span><span class="opt">;</span>
        <span class="opt">}</span>
        <span class="kwa">if</span> solution <span class="opt">&lt;</span> min <span class="opt">{</span>
            min <span class="opt">=</span> solution<span class="opt">;</span>
        <span class="opt">}</span> <span class="kwa">else if</span> solution <span class="opt">&gt;</span> max <span class="opt">{</span>
            max <span class="opt">=</span> solution<span class="opt">;</span>
        <span class="opt">}</span>
        num_found <span class="opt">+=</span> <span class="num">1</span><span class="opt">;</span>
    <span class="opt">}</span>

    <span class="opt">(</span>min<span class="opt">,</span> max<span class="opt">,</span> num_found<span class="opt">)</span>
<span class="opt">}</span>

<span class="kwa">fn</span> <span class="kwd">spawn_solvers</span><span class="opt">() -&gt;</span> Receiver<span class="opt">&lt;</span>Solution<span class="opt">&gt; {</span>
    <span class="kwa">let</span> mask_lookup <span class="opt">=</span> Arc<span class="opt">::</span><span class="kwd">new</span><span class="opt">(</span>MaskLookup<span class="opt">::</span><span class="kwd">new</span><span class="opt">());</span>

    <span class="kwa">let</span> <span class="opt">(</span>solution_sender<span class="opt">,</span> solution_receiver<span class="opt">) =</span> <span class="kwd">channel</span><span class="opt">();</span>

    <span class="kwa">for</span> first_piece <span class="kwa">in</span> <span class="opt">(</span><span class="num">0</span><span class="opt">..</span>NUM_PIECES<span class="opt">) {</span>
        <span class="kwa">let</span> num_masks <span class="opt">=</span> mask_lookup<span class="opt">.</span><span class="kwd">get</span><span class="opt">(</span>first_piece<span class="opt">,</span> LAST_POSITION<span class="opt">).</span><span class="kwd">len</span><span class="opt">();</span>

        <span class="kwa">for</span> mask_idx <span class="kwa">in</span> <span class="opt">(</span><span class="num">0</span><span class="opt">..</span>num_masks<span class="opt">) {</span>
            <span class="kwa">let</span> my_solution_sender <span class="opt">=</span> solution_sender<span class="opt">.</span><span class="kwd">clone</span><span class="opt">();</span>
            <span class="kwa">let</span> my_mask_lookup <span class="opt">=</span> mask_lookup<span class="opt">.</span><span class="kwd">clone</span><span class="opt">();</span>

            <span class="kwd">spawn</span><span class="opt">(</span><span class="kwa">move</span> <span class="opt">|| {</span>
                <span class="kwa">let mut</span> solver <span class="opt">=</span> Solver<span class="opt">::</span><span class="kwd">new</span><span class="opt">(</span>
                    <span class="opt">&amp;*</span>my_mask_lookup<span class="opt">,</span>
                    <span class="opt">&amp;</span>my_solution_sender<span class="opt">);</span>
                solver<span class="opt">.</span><span class="kwd">place_piece</span><span class="opt">(</span>first_piece<span class="opt">,</span>
                                   LAST_POSITION<span class="opt">,</span>
                                   mask_idx<span class="opt">,</span>
                                   num_masks<span class="opt">);</span>
            <span class="opt">});</span>
        <span class="opt">}</span>
    <span class="opt">}</span>
    solution_receiver
<span class="opt">}</span>

<span class="kwa">struct</span> Solver<span class="opt">&lt;</span>&apos;a<span class="opt">&gt; {</span>
    mask_lookup<span class="opt">: &amp;</span>&apos;a MaskLookup<span class="opt">,</span>
    masks<span class="opt">: [</span><span class="kwb">u64</span><span class="opt">;</span> NUM_PIECES<span class="opt">],</span>
    mask <span class="opt">:</span> <span class="kwb">u64</span><span class="opt">,</span>
    used_pieces<span class="opt">:</span> <span class="kwb">usize</span><span class="opt">,</span>
    solution_sender <span class="opt">: &amp;</span>&apos;a Sender<span class="opt">&lt;</span>Solution<span class="opt">&gt;,</span>
    solution<span class="opt">:</span> Solution<span class="opt">,</span>
    reversed_solution<span class="opt">:</span> Solution
<span class="opt">}</span>

<span class="kwa">impl</span><span class="opt">&lt;</span>&apos;a<span class="opt">&gt;</span> Solver<span class="opt">&lt;</span>&apos;a<span class="opt">&gt; {</span>
    <span class="kwa">fn</span> <span class="kwd">new</span><span class="opt">(</span>mask_lookup <span class="opt">: &amp;</span>&apos;a MaskLookup<span class="opt">,</span>
           solution_sender <span class="opt">: &amp;</span>&apos;a Sender<span class="opt">&lt;</span>Solution<span class="opt">&gt;) -&gt;</span> Solver<span class="opt">&lt;</span>&apos;a<span class="opt">&gt; {</span>
        Solver <span class="opt">{</span>
            mask_lookup<span class="opt">:</span> mask_lookup<span class="opt">,</span>
            masks<span class="opt">: [</span><span class="num">0</span><span class="opt">;</span> NUM_PIECES<span class="opt">],</span>
            mask<span class="opt">:</span> <span class="num">0</span><span class="opt">,</span>
            used_pieces<span class="opt">:</span> <span class="num">0</span><span class="opt">,</span>
            solution_sender<span class="opt">:</span> solution_sender<span class="opt">,</span>
            solution<span class="opt">:</span> Solution<span class="opt">::</span><span class="kwd">default</span><span class="opt">(),</span>
            reversed_solution<span class="opt">:</span> Solution<span class="opt">::</span><span class="kwd">default</span><span class="opt">()</span>
        <span class="opt">}</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">place_piece</span><span class="opt">(&amp;</span><span class="kwa">mut self</span><span class="opt">,</span>
                   piece <span class="opt">:</span> <span class="kwb">usize</span><span class="opt">,</span>
                   position <span class="opt">:</span> <span class="kwb">usize</span><span class="opt">,</span>
                   start <span class="opt">:</span> <span class="kwb">usize</span><span class="opt">,</span>
                   step <span class="opt">:</span> <span class="kwb">usize</span><span class="opt">) {</span>
        <span class="kwa">self</span><span class="opt">.</span><span class="kwd">toggle_piece</span><span class="opt">(</span>piece<span class="opt">);</span>
        <span class="kwa">let</span> masks <span class="opt">=</span> <span class="kwa">self</span><span class="opt">.</span>mask_lookup<span class="opt">.</span><span class="kwd">get</span><span class="opt">(</span>piece<span class="opt">,</span> position<span class="opt">);</span>
        <span class="kwa">let mut</span> idx <span class="opt">=</span> start<span class="opt">;</span>
        <span class="kwa">while</span> idx <span class="opt">&lt;</span> masks<span class="opt">.</span><span class="kwd">len</span><span class="opt">() {</span>
            <span class="kwa">self</span><span class="opt">.</span><span class="kwd">evaluate</span><span class="opt">(</span>piece<span class="opt">,</span> masks<span class="opt">[</span>idx<span class="opt">]);</span>
            idx <span class="opt">+=</span> step<span class="opt">;</span>
        <span class="opt">}</span>
        <span class="kwa">self</span><span class="opt">.</span><span class="kwd">toggle_piece</span><span class="opt">(</span>piece<span class="opt">);</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">evaluate</span><span class="opt">(&amp;</span><span class="kwa">mut self</span><span class="opt">,</span> piece <span class="opt">:</span> <span class="kwb">usize</span><span class="opt">,</span> mask <span class="opt">:</span> <span class="kwb">u64</span><span class="opt">) {</span>
        <span class="kwa">if self</span><span class="num">.fi</span>ts<span class="opt">(</span>mask<span class="opt">) {</span>
            <span class="kwa">self</span><span class="opt">.</span><span class="kwd">place_mask</span><span class="opt">(</span>piece<span class="opt">,</span> mask<span class="opt">);</span>
            <span class="kwa">if self</span><span class="opt">.</span><span class="kwd">done</span><span class="opt">() {</span>
                <span class="kwa">self</span><span class="opt">.</span><span class="kwd">send_solution</span><span class="opt">();</span>
            <span class="opt">}</span> <span class="kwa">else if self</span><span class="opt">.</span><span class="kwd">still_possible</span><span class="opt">() {</span>
                <span class="kwa">self</span><span class="opt">.</span><span class="kwd">choose_piece</span><span class="opt">();</span>
            <span class="opt">}</span>
            <span class="kwa">self</span><span class="num">.u</span>nplace<span class="num">_</span>mask<span class="opt">(</span>mask<span class="opt">);</span>
        <span class="opt">}</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">choose_piece</span><span class="opt">(&amp;</span><span class="kwa">mut self</span><span class="opt">) {</span>
        <span class="kwa">let</span> position <span class="opt">=</span> <span class="kwa">self</span><span class="num">.fi</span>rst<span class="num">_f</span>ree<span class="num">_</span>pos<span class="num">i</span>t<span class="num">i</span>on<span class="opt">();</span>
        <span class="kwa">let mut</span> piece <span class="opt">=</span> <span class="num">0</span><span class="opt">;</span>
        <span class="kwa">while</span> piece <span class="opt">&lt;</span> NUM_PIECES <span class="opt">{</span>
            <span class="kwa">if self</span><span class="num">.i</span>s<span class="num">_</span>not<span class="num">_</span>placed<span class="opt">(</span>piece<span class="opt">) {</span>
                <span class="kwa">self</span><span class="opt">.</span><span class="kwd">place_piece</span><span class="opt">(</span>piece<span class="opt">,</span> position<span class="opt">,</span> <span class="num">0</span><span class="opt">,</span> <span class="num">1</span><span class="opt">);</span>
            <span class="opt">}</span>
            piece <span class="opt">+=</span> <span class="num">1</span><span class="opt">;</span>
        <span class="opt">}</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">toggle_piece</span><span class="opt">(&amp;</span><span class="kwa">mut self</span><span class="opt">,</span> piece <span class="opt">:</span> <span class="kwb">usize</span><span class="opt">) {</span>
        <span class="kwa">self</span><span class="num">.u</span>sed<span class="num">_</span>p<span class="num">i</span>eces ^<span class="opt">=</span> <span class="num">1</span> <span class="opt">&lt;&lt;</span> piece<span class="opt">;</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">place_mask</span><span class="opt">(&amp;</span><span class="kwa">mut self</span><span class="opt">,</span> piece<span class="opt">:</span> <span class="kwb">usize</span><span class="opt">,</span> mask <span class="opt">:</span> <span class="kwb">u64</span><span class="opt">) {</span>
        <span class="kwa">self</span><span class="opt">.</span>mask ^<span class="opt">=</span> mask<span class="opt">;</span>
        <span class="kwa">self</span><span class="opt">.</span>masks<span class="opt">[</span>piece<span class="opt">] =</span> mask<span class="opt">;</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">unplace_mask</span><span class="opt">(&amp;</span><span class="kwa">mut self</span><span class="opt">,</span> mask <span class="opt">:</span> <span class="kwb">u64</span><span class="opt">) {</span>
        <span class="kwa">self</span><span class="opt">.</span>mask ^<span class="opt">=</span> mask<span class="opt">;</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">done</span><span class="opt">(&amp;</span><span class="kwa">self</span><span class="opt">) -&gt;</span> bool <span class="opt">{</span>
        <span class="kwa">self</span><span class="num">.u</span>sed<span class="num">_</span>p<span class="num">i</span>eces <span class="opt">== (</span><span class="num">1</span> <span class="opt">&lt;&lt;</span> NUM_PIECES<span class="opt">) -</span> <span class="num">1</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">still_possible</span><span class="opt">(&amp;</span><span class="kwa">self</span><span class="opt">) -&gt;</span> bool <span class="opt">{</span>
        <span class="kwd">no_islands</span><span class="opt">(</span><span class="kwa">self</span><span class="opt">.</span>mask<span class="opt">)</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">first_free_position</span><span class="opt">(&amp;</span><span class="kwa">self</span><span class="opt">) -&gt;</span> <span class="kwb">usize</span> <span class="opt">{</span>
        <span class="kwd">find_first_one</span><span class="opt">(!</span><span class="kwa">self</span><span class="opt">.</span>mask <span class="opt">&amp;</span> FULL_MASK<span class="opt">)</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">is_not_placed</span><span class="opt">(&amp;</span><span class="kwa">self</span><span class="opt">,</span> piece <span class="opt">:</span> <span class="kwb">usize</span><span class="opt">) -&gt;</span> bool <span class="opt">{</span>
        <span class="kwa">self</span><span class="num">.u</span>sed<span class="num">_</span>p<span class="num">i</span>eces <span class="opt">&amp; (</span><span class="num">1</span> <span class="opt">&lt;&lt;</span> piece<span class="opt">) ==</span> <span class="num">0</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">fits</span><span class="opt">(&amp;</span><span class="kwa">self</span><span class="opt">,</span> mask <span class="opt">:</span> <span class="kwb">u64</span><span class="opt">) -&gt;</span> bool <span class="opt">{</span>
        <span class="kwa">self</span><span class="opt">.</span>mask <span class="opt">&amp;</span> mask <span class="opt">==</span> <span class="num">0</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">send_solution</span><span class="opt">(&amp;</span><span class="kwa">mut self</span><span class="opt">) {</span>
        <span class="kwa">self</span><span class="num">.fi</span>ll<span class="num">_</span>sol<span class="num">u</span>t<span class="num">i</span>ons<span class="opt">();</span>
        <span class="kwa">let</span> _ <span class="opt">=</span> <span class="kwa">self</span><span class="opt">.</span>solution_sender<span class="opt">.</span><span class="kwd">send</span><span class="opt">(</span><span class="kwa">self</span><span class="opt">.</span>solution<span class="opt">.</span><span class="kwd">clone</span><span class="opt">());</span>
        <span class="kwa">let</span> _ <span class="opt">=</span> <span class="kwa">self</span><span class="opt">.</span>solution_sender<span class="opt">.</span><span class="kwd">send</span><span class="opt">(</span><span class="kwa">self</span><span class="opt">.</span>reversed_solution<span class="opt">.</span><span class="kwd">clone</span><span class="opt">());</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">fill_solutions</span><span class="opt">(&amp;</span><span class="kwa">mut self</span><span class="opt">) {</span>
        <span class="kwa">for</span> position <span class="kwa">in</span> <span class="opt">(</span><span class="num">0</span><span class="opt">..</span>NUM_POSITIONS<span class="opt">) {</span>
            <span class="kwa">let</span> piece <span class="opt">=</span> <span class="kwa">self</span><span class="opt">.</span><span class="kwd">piece_at_position</span><span class="opt">(</span>position<span class="opt">);</span>
            <span class="kwa">self</span><span class="opt">.</span>solution<span class="opt">.</span>pieces<span class="opt">[</span>position<span class="opt">] =</span> piece<span class="opt">;</span>
            <span class="kwa">let</span> reversed_position <span class="opt">=</span> LAST_POSITION <span class="opt">-</span> position<span class="opt">;</span>
            <span class="kwa">self</span><span class="opt">.</span>reversed_solution<span class="opt">.</span>pieces<span class="opt">[</span>reversed_position<span class="opt">] =</span> piece<span class="opt">;</span>
        <span class="opt">}</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">piece_at_position</span><span class="opt">(&amp;</span><span class="kwa">self</span><span class="opt">,</span> position <span class="opt">:</span> <span class="kwb">usize</span><span class="opt">) -&gt;</span> <span class="kwb">u8</span> <span class="opt">{</span>
        <span class="kwa">let</span> position_mask <span class="opt">=</span> <span class="num">1</span> <span class="opt">&lt;&lt;</span> position<span class="opt">;</span>
        <span class="kwa">for</span> piece <span class="kwa">in</span> <span class="opt">(</span><span class="num">0</span><span class="opt">..</span>NUM_PIECES<span class="opt">) {</span>
            <span class="kwa">let</span> mask <span class="opt">=</span> <span class="kwa">self</span><span class="opt">.</span>masks<span class="opt">[</span>piece<span class="opt">];</span>
            <span class="kwa">let</span> uses_piece <span class="opt">= (</span><span class="kwa">self</span><span class="num">.u</span>sed<span class="num">_</span>p<span class="num">i</span>eces <span class="opt">&gt;&gt;</span> piece<span class="opt">) &amp;</span> <span class="num">1</span> <span class="opt">==</span> <span class="num">1</span><span class="opt">;</span>
            <span class="kwa">let</span> occupies_position <span class="opt">=</span> <span class="kwd">overlaps</span><span class="opt">(</span>mask<span class="opt">,</span> position_mask<span class="opt">);</span>
            <span class="kwa">if</span> uses_piece <span class="opt">&amp;&amp;</span> occupies_position <span class="opt">{</span>
                <span class="kwa">return</span> piece <span class="kwa">as</span> <span class="kwb">u8</span><span class="opt">;</span>
            <span class="opt">}</span>
        <span class="opt">}</span>
        <span class="kwa">return</span> <span class="num">0</span><span class="opt">;</span>
    <span class="opt">}</span>
<span class="opt">}</span>


<span class="kwa">struct</span> Solution <span class="opt">{</span>
    pieces<span class="opt">: [</span><span class="kwb">u8</span><span class="opt">;</span> NUM_POSITIONS<span class="opt">]</span>
<span class="opt">}</span>

<span class="kwa">impl</span> Solution <span class="opt">{</span>
    <span class="kwa">fn</span> <span class="kwd">default</span><span class="opt">() -&gt;</span> Solution <span class="opt">{</span>
        Solution <span class="opt">{</span>
            pieces<span class="opt">: [</span><span class="num">0</span><span class="opt">;</span> NUM_POSITIONS<span class="opt">]</span>
        <span class="opt">}</span>
    <span class="opt">}</span>
<span class="opt">}</span>

<span class="kwa">impl</span> Clone <span class="kwa">for</span> Solution <span class="opt">{</span>
    <span class="kwa">fn</span> <span class="kwd">clone</span><span class="opt">(&amp;</span><span class="kwa">self</span><span class="opt">) -&gt;</span> Solution <span class="opt">{</span>
        Solution <span class="opt">{</span>
            pieces<span class="opt">:</span> <span class="kwa">self</span><span class="opt">.</span>pieces
        <span class="opt">}</span>
    <span class="opt">}</span>
<span class="opt">}</span>

<span class="kwa">impl</span> PartialOrd <span class="kwa">for</span> Solution <span class="opt">{</span>
    <span class="kwa">fn</span> <span class="kwd">partial_cmp</span><span class="opt">(&amp;</span><span class="kwa">self</span><span class="opt">,</span> other <span class="opt">: &amp;</span>Solution<span class="opt">) -&gt;</span> Option<span class="opt">&lt;</span>Ordering<span class="opt">&gt; {</span>
        <span class="kwa">for</span> i <span class="kwa">in</span> <span class="opt">(</span><span class="num">0</span><span class="opt">..</span>NUM_POSITIONS<span class="opt">) {</span>
            <span class="kwa">if self</span><span class="opt">.</span>pieces<span class="opt">[</span>i<span class="opt">] &lt;</span> other<span class="opt">.</span>pieces<span class="opt">[</span>i<span class="opt">] {</span>
                <span class="kwa">return</span> <span class="kwd">Some</span><span class="opt">(</span>Ordering<span class="opt">::</span>Less<span class="opt">)</span>
            <span class="opt">}</span> <span class="kwa">else if self</span><span class="opt">.</span>pieces<span class="opt">[</span>i<span class="opt">] &gt;</span> other<span class="opt">.</span>pieces<span class="opt">[</span>i<span class="opt">] {</span>
                <span class="kwa">return</span> <span class="kwd">Some</span><span class="opt">(</span>Ordering<span class="opt">::</span>Greater<span class="opt">)</span>
            <span class="opt">}</span>
        <span class="opt">}</span>
        <span class="kwd">Some</span><span class="opt">(</span>Ordering<span class="opt">::</span>Equal<span class="opt">)</span>
    <span class="opt">}</span>
<span class="opt">}</span>

<span class="kwa">impl</span> PartialEq <span class="kwa">for</span> Solution <span class="opt">{</span>
    <span class="kwa">fn</span> <span class="kwd">eq</span><span class="opt">(&amp;</span><span class="kwa">self</span><span class="opt">,</span> other <span class="opt">: &amp;</span>Solution<span class="opt">) -&gt;</span> bool <span class="opt">{</span>
        <span class="kwa">self</span><span class="opt">.</span>pieces<span class="opt">.</span><span class="kwd">partial_cmp</span><span class="opt">(</span>other<span class="opt">.</span>pieces<span class="opt">.</span><span class="kwd">as_ref</span><span class="opt">()) ==</span> <span class="kwd">Some</span><span class="opt">(</span>Ordering<span class="opt">::</span>Equal<span class="opt">)</span>
    <span class="opt">}</span>
<span class="opt">}</span>

<span class="kwa">impl</span> Solution <span class="opt">{</span>
    <span class="kwa">fn</span> <span class="kwd">pretty_print</span><span class="opt">(&amp;</span><span class="kwa">self</span><span class="opt">) {</span>
        <span class="kwa">for</span> <span class="opt">(</span>idx<span class="opt">, &amp;</span>piece<span class="opt">)</span> <span class="kwa">in self</span><span class="opt">.</span>pieces<span class="num">.i</span>ter<span class="opt">().</span><span class="kwd">enumerate</span><span class="opt">() {</span>
            <span class="kwa">let</span> glyph <span class="opt">= ((</span>&apos;<span class="num">0</span>&apos; <span class="kwa">as</span> <span class="kwb">u8</span><span class="opt">) +</span> piece<span class="opt">)</span> <span class="kwa">as</span> <span class="kwb">char</span><span class="opt">;</span>
            print<span class="opt">!(</span><span class="str">&quot;{}&quot;</span><span class="opt">,</span> glyph<span class="opt">);</span>
            print<span class="opt">!(</span><span class="str">&quot; &quot;</span><span class="opt">);</span>

            <span class="kwa">let</span> x <span class="opt">=</span> idx <span class="opt">%</span> WIDTH<span class="opt">;</span>
            <span class="kwa">let</span> y <span class="opt">=</span> idx <span class="opt">/</span> WIDTH<span class="opt">;</span>

            <span class="kwa">if</span> x <span class="opt">==</span> WIDTH<span class="opt">-</span><span class="num">1</span> <span class="opt">{</span>
                <span class="kwa">if</span> y<span class="opt">%</span><span class="num">2</span> <span class="opt">==</span> <span class="num">0</span> <span class="opt">{</span>
                    print<span class="opt">!(</span><span class="str">&quot;</span><span class="esc">\</span><span class="str">n &quot;</span><span class="opt">);</span>
                <span class="opt">}</span> <span class="kwa">else</span> <span class="opt">{</span>
                    print<span class="opt">!(</span><span class="str">&quot;</span><span class="esc">\</span><span class="str">n&quot;</span><span class="opt">);</span>
                <span class="opt">}</span>
            <span class="opt">}</span>
        <span class="opt">}</span>
        print<span class="opt">!(</span><span class="str">&quot;</span><span class="esc">\</span><span class="str">n&quot;</span><span class="opt">);</span>
    <span class="opt">}</span>
<span class="opt">}</span>

<span class="kwa">struct</span> MaskLookup <span class="opt">{</span>
    masks_by_piece_and_position<span class="opt">:</span> Vec<span class="opt">&lt;</span>Vec<span class="opt">&lt;</span><span class="kwb">u64</span><span class="opt">&gt;&gt;</span>
<span class="opt">}</span>

<span class="kwa">impl</span> MaskLookup <span class="opt">{</span>
    <span class="kwa">fn</span> <span class="kwd">new</span><span class="opt">() -&gt;</span> MaskLookup <span class="opt">{</span>
        <span class="kwa">let mut</span> ml <span class="opt">=</span> MaskLookup<span class="opt">::</span><span class="kwd">default</span><span class="opt">();</span>
        ml<span class="opt">.</span><span class="kwd">add_piece</span><span class="opt">(</span><span class="kwa">false</span><span class="opt">,</span> <span class="num">0</span><span class="opt">, &amp;[</span>E<span class="opt">,</span> E<span class="opt">,</span> E<span class="opt">,</span> SE<span class="opt">]);</span>
        ml<span class="opt">.</span><span class="kwd">add_piece</span><span class="opt">(</span><span class="kwa">false</span><span class="opt">,</span> <span class="num">1</span><span class="opt">, &amp;[</span>SE<span class="opt">,</span> SW<span class="opt">,</span> W<span class="opt">,</span> SW<span class="opt">]);</span>
        ml<span class="opt">.</span><span class="kwd">add_piece</span><span class="opt">(</span><span class="kwa">false</span><span class="opt">,</span> <span class="num">2</span><span class="opt">, &amp;[</span>W<span class="opt">,</span> W<span class="opt">,</span> SW<span class="opt">,</span> SE<span class="opt">]);</span>
        ml<span class="opt">.</span><span class="kwd">add_piece</span><span class="opt">(</span><span class="kwa">true</span><span class="opt">,</span>  <span class="num">3</span><span class="opt">, &amp;[</span>E<span class="opt">,</span> E<span class="opt">,</span> SW<span class="opt">,</span> SE<span class="opt">]);</span>
        ml<span class="opt">.</span><span class="kwd">add_piece</span><span class="opt">(</span><span class="kwa">false</span><span class="opt">,</span> <span class="num">4</span><span class="opt">, &amp;[</span>NW<span class="opt">,</span> W<span class="opt">,</span> NW<span class="opt">,</span> SE<span class="opt">,</span> SW<span class="opt">]);</span>
        ml<span class="opt">.</span><span class="kwd">add_piece</span><span class="opt">(</span><span class="kwa">false</span><span class="opt">,</span> <span class="num">5</span><span class="opt">, &amp;[</span>E<span class="opt">,</span> E<span class="opt">,</span>  NE<span class="opt">,</span> W<span class="opt">]);</span>
        ml<span class="opt">.</span><span class="kwd">add_piece</span><span class="opt">(</span><span class="kwa">false</span><span class="opt">,</span> <span class="num">6</span><span class="opt">, &amp;[</span>NW<span class="opt">,</span> NE<span class="opt">,</span> NE<span class="opt">,</span> W<span class="opt">]);</span>
        ml<span class="opt">.</span><span class="kwd">add_piece</span><span class="opt">(</span><span class="kwa">false</span><span class="opt">,</span> <span class="num">7</span><span class="opt">, &amp;[</span>NE<span class="opt">,</span> SE<span class="opt">,</span> E<span class="opt">,</span> NE<span class="opt">]);</span>
        ml<span class="opt">.</span><span class="kwd">add_piece</span><span class="opt">(</span><span class="kwa">false</span><span class="opt">,</span> <span class="num">8</span><span class="opt">, &amp;[</span>SE<span class="opt">,</span> SE<span class="opt">,</span> E<span class="opt">,</span> SE<span class="opt">]);</span>
        ml<span class="opt">.</span><span class="kwd">add_piece</span><span class="opt">(</span><span class="kwa">false</span><span class="opt">,</span> <span class="num">9</span><span class="opt">, &amp;[</span>E<span class="opt">,</span> NW<span class="opt">,</span> NW<span class="opt">,</span> NW<span class="opt">]);</span>
        ml
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">default</span><span class="opt">() -&gt;</span> MaskLookup <span class="opt">{</span>
        MaskLookup <span class="opt">{</span>
            masks_by_piece_and_position<span class="opt">:</span>
            <span class="opt">(</span><span class="num">0</span><span class="opt">..</span>NUM_PIECES <span class="opt">*</span> NUM_POSITIONS<span class="opt">).</span><span class="kwd">map</span><span class="opt">(|</span>_<span class="opt">|</span> Vec<span class="opt">::</span><span class="kwd">with_capacity</span><span class="opt">(</span><span class="num">2</span><span class="opt">*</span><span class="num">6</span><span class="opt">)).</span><span class="kwd">collect</span><span class="opt">()</span>
        <span class="opt">}</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">add_piece</span><span class="opt">(&amp;</span><span class="kwa">mut self</span><span class="opt">,</span>
                 fully_rotated <span class="opt">:</span> bool<span class="opt">,</span>
                 index <span class="opt">:</span> <span class="kwb">usize</span><span class="opt">,</span>
                 directions <span class="opt">: &amp;[</span>Direction<span class="opt">]) {</span>
        <span class="kwa">let mut</span> piece <span class="opt">:</span> Piece <span class="opt">=</span> Piece<span class="opt">::</span><span class="kwd">new</span><span class="opt">(</span>directions<span class="opt">);</span>
        <span class="kwa">let</span> num_orientations <span class="opt">:</span> <span class="kwb">usize</span> <span class="opt">=</span> <span class="num">2</span><span class="opt">;</span>
        <span class="kwa">let</span> num_rotations <span class="opt">:</span> <span class="kwb">usize</span> <span class="opt">=</span> <span class="kwa">if</span> fully_rotated <span class="opt">{</span><span class="num">3</span><span class="opt">}</span> <span class="kwa">else</span> <span class="opt">{</span><span class="num">6</span><span class="opt">};</span>

        <span class="kwa">for</span> _ <span class="kwa">in</span> <span class="opt">(</span><span class="num">0</span><span class="opt">..</span>num_orientations<span class="opt">) {</span>
            <span class="kwa">for</span> _ <span class="kwa">in</span> <span class="opt">(</span><span class="num">0</span><span class="opt">..</span>num_rotations<span class="opt">) {</span>
                <span class="kwa">for</span> x <span class="kwa">in</span> <span class="opt">(</span><span class="num">0</span><span class="opt">..</span>WIDTH <span class="kwa">as</span> <span class="kwb">isize</span><span class="opt">) {</span>
                    <span class="kwa">for</span> y <span class="kwa">in</span> <span class="opt">(</span><span class="num">0</span><span class="opt">..</span>HEIGHT <span class="kwa">as</span> <span class="kwb">isize</span><span class="opt">) {</span>
                        <span class="kwa">let</span> position <span class="opt">=</span> Position<span class="opt">::</span><span class="kwd">new</span><span class="opt">(</span>x<span class="opt">,</span>y<span class="opt">);</span>
                        <span class="kwa">self</span><span class="opt">.</span><span class="kwd">add_piece_at_position</span><span class="opt">(</span>index<span class="opt">,</span>
                                                   <span class="opt">&amp;</span>piece<span class="opt">,</span>
                                                   position<span class="opt">);</span>
                    <span class="opt">}</span>
                <span class="opt">}</span>
                piece <span class="opt">=</span> piece<span class="opt">.</span><span class="kwd">rotate</span><span class="opt">();</span>
            <span class="opt">}</span>
            piece <span class="opt">=</span> piece<span class="num">.f</span>l<span class="num">i</span>p<span class="opt">();</span>
        <span class="opt">}</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">add_piece_at_position</span><span class="opt">(&amp;</span><span class="kwa">mut self</span><span class="opt">,</span>
                             index <span class="opt">:</span> <span class="kwb">usize</span><span class="opt">,</span>
                             piece <span class="opt">: &amp;</span>Piece<span class="opt">,</span>
                             position <span class="opt">:</span> Position<span class="opt">) {</span>

        <span class="kwa">match</span> piece<span class="opt">.</span><span class="kwd">to_mask</span><span class="opt">(</span>position<span class="opt">) {</span>
            <span class="kwd">Some</span><span class="opt">(</span>mask<span class="opt">) =&gt; {</span>
                <span class="kwa">let</span> last <span class="opt">=</span> <span class="kwd">find_first_one</span><span class="opt">(</span>mask<span class="opt">);</span>
                <span class="kwa">let</span> idx <span class="opt">=</span> index<span class="opt">*</span>NUM_POSITIONS <span class="opt">+</span> last<span class="opt">;</span>
                <span class="kwa">self</span><span class="opt">.</span>masks_by_piece_and_position<span class="opt">.</span><span class="kwd">get_mut</span><span class="opt">(</span>idx<span class="opt">)</span><span class="num">.u</span>nwrap<span class="opt">().</span><span class="kwd">push</span><span class="opt">(</span>mask<span class="opt">);</span>
            <span class="opt">}</span>
            None <span class="opt">=&gt; ()</span>
        <span class="opt">}</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> get<span class="opt">&lt;</span>&apos;a<span class="opt">&gt;(&amp;</span>&apos;a <span class="kwa">self</span><span class="opt">,</span> index <span class="opt">:</span> <span class="kwb">usize</span><span class="opt">,</span> position <span class="opt">:</span> <span class="kwb">usize</span><span class="opt">) -&gt; &amp;</span>&apos;a <span class="opt">[</span><span class="kwb">u64</span><span class="opt">] {</span>
        <span class="kwa">let</span> idx <span class="opt">=</span> index<span class="opt">*</span>NUM_POSITIONS <span class="opt">+</span> position<span class="opt">;</span>
        <span class="kwa">self</span><span class="opt">.</span>masks_by_piece_and_position<span class="opt">[</span>idx<span class="opt">].</span><span class="kwd">as_ref</span><span class="opt">()</span>
    <span class="opt">}</span>
<span class="opt">}</span>

<span class="ppc">#[derive(Clone)]</span>
<span class="kwa">struct</span> Piece <span class="opt">{</span>
    directions<span class="opt">:</span> Vec<span class="opt">&lt;</span>Direction<span class="opt">&gt;</span>
<span class="opt">}</span>

<span class="kwa">impl</span> Piece <span class="opt">{</span>
    <span class="kwa">fn</span> <span class="kwd">new</span><span class="opt">(</span>directions <span class="opt">: &amp;[</span>Direction<span class="opt">]) -&gt;</span> Piece <span class="opt">{</span>
        Piece <span class="opt">{</span>
            directions<span class="opt">: (</span><span class="num">0</span><span class="opt">..</span>directions<span class="opt">.</span><span class="kwd">len</span><span class="opt">()).</span><span class="kwd">map</span><span class="opt">(|</span>i<span class="opt">|</span> directions<span class="opt">[</span>i<span class="opt">].</span><span class="kwd">clone</span><span class="opt">()).</span><span class="kwd">collect</span><span class="opt">()</span>
        <span class="opt">}</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">to_mask</span><span class="opt">(&amp;</span><span class="kwa">self</span><span class="opt">,</span> position <span class="opt">:</span> Position<span class="opt">) -&gt;</span> Option<span class="opt">&lt;</span><span class="kwb">u64</span><span class="opt">&gt; {</span>
        <span class="kwa">let mut</span> mask <span class="opt">=</span> position<span class="opt">.</span><span class="kwd">to_mask</span><span class="opt">();</span>
        <span class="kwa">let mut</span> current_position <span class="opt">=</span> position<span class="opt">;</span>

        <span class="kwa">for</span> direction <span class="kwa">in self</span><span class="opt">.</span>directions<span class="num">.i</span>ter<span class="opt">() {</span>
            <span class="kwa">match</span> current_position<span class="num">.i</span>n<span class="num">_</span>d<span class="num">i</span>rect<span class="num">i</span>on<span class="opt">(</span>direction<span class="opt">) {</span>
                <span class="kwd">Some</span><span class="opt">(</span>position<span class="opt">) =&gt; {</span>
                    current_position <span class="opt">=</span> position<span class="opt">;</span>
                    mask <span class="opt">|=</span> current_position<span class="opt">.</span><span class="kwd">to_mask</span><span class="opt">();</span>
                <span class="opt">},</span>
                None <span class="opt">=&gt;</span> <span class="kwa">return</span> None
            <span class="opt">}</span>
        <span class="opt">}</span>
        <span class="kwa">return</span> Piece<span class="opt">::</span><span class="kwd">prune</span><span class="opt">(</span>mask<span class="opt">);</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">prune</span><span class="opt">(</span>mask <span class="opt">:</span> <span class="kwb">u64</span><span class="opt">) -&gt;</span> Option<span class="opt">&lt;</span><span class="kwb">u64</span><span class="opt">&gt; {</span>
        <span class="kwa">let</span> border <span class="opt">=</span> <span class="num">0b11111_10001_10001_10001_10001_10001_10001_10001_10001_11111</span><span class="opt">;</span>
        <span class="kwa">if</span> mask <span class="opt">&amp;</span> border <span class="opt">==</span> <span class="num">0</span> <span class="opt">||</span> <span class="kwd">no_islands</span><span class="opt">(</span>mask<span class="opt">) {</span>
            <span class="kwd">Some</span><span class="opt">(</span>mask<span class="opt">)</span>
        <span class="opt">}</span> <span class="kwa">else</span> <span class="opt">{</span>
            None
        <span class="opt">}</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">flip</span><span class="opt">(&amp;</span><span class="kwa">self</span><span class="opt">) -&gt;</span> Piece <span class="opt">{</span>
        <span class="kwa">self</span><span class="opt">.</span><span class="kwd">as_modified</span><span class="opt">(|</span>x<span class="opt">|</span> x<span class="num">.f</span>l<span class="num">i</span>p<span class="opt">())</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">rotate</span><span class="opt">(&amp;</span><span class="kwa">self</span><span class="opt">) -&gt;</span> Piece <span class="opt">{</span>
        <span class="kwa">self</span><span class="opt">.</span><span class="kwd">as_modified</span><span class="opt">(|</span>x<span class="opt">|</span> x<span class="opt">.</span><span class="kwd">rotate</span><span class="opt">())</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> as_modified<span class="opt">&lt;</span>F <span class="opt">:</span> <span class="kwd">Fn</span><span class="opt">(&amp;</span>Direction<span class="opt">) -&gt;</span> Direction<span class="opt">&gt;(&amp;</span><span class="kwa">self</span><span class="opt">,</span> fun <span class="opt">:</span> F<span class="opt">) -&gt;</span> Piece <span class="opt">{</span>
        Piece <span class="opt">{</span>
            directions<span class="opt">:</span> <span class="kwa">self</span><span class="opt">.</span>directions<span class="num">.i</span>ter<span class="opt">().</span><span class="kwd">map</span><span class="opt">(</span>fun<span class="opt">).</span><span class="kwd">collect</span><span class="opt">()</span>
        <span class="opt">}</span>
    <span class="opt">}</span>
<span class="opt">}</span>

<span class="ppc">#[derive(Clone)]</span>
<span class="kwa">struct</span> Position <span class="opt">{</span>
    x<span class="opt">:</span> <span class="kwb">isize</span><span class="opt">,</span>
    y<span class="opt">:</span> <span class="kwb">isize</span>
<span class="opt">}</span>

<span class="kwa">impl</span> Position <span class="opt">{</span>
    <span class="kwa">fn</span> <span class="kwd">new</span><span class="opt">(</span>x <span class="opt">:</span> <span class="kwb">isize</span><span class="opt">,</span> y <span class="opt">:</span> <span class="kwb">isize</span><span class="opt">) -&gt;</span> Position <span class="opt">{</span>
        Position <span class="opt">{</span>x<span class="opt">:</span>x<span class="opt">,</span> y<span class="opt">:</span>y<span class="opt">}</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">in_direction</span><span class="opt">(&amp;</span><span class="kwa">self</span><span class="opt">,</span> direction <span class="opt">: &amp;</span>Direction<span class="opt">) -&gt;</span> Option<span class="opt">&lt;</span>Position<span class="opt">&gt; {</span>

        <span class="kwa">let</span> <span class="opt">(</span>dx<span class="opt">,</span> dy<span class="opt">) =</span>
            <span class="kwa">match</span> direction <span class="opt">{</span>
                <span class="opt">&amp;</span>E <span class="opt">=&gt; (-</span><span class="num">1</span><span class="opt">,</span> <span class="num">0</span><span class="opt">),</span>
                <span class="opt">&amp;</span>W <span class="opt">=&gt; (</span> <span class="num">1</span><span class="opt">,</span> <span class="num">0</span><span class="opt">),</span>
                <span class="opt">&amp;</span>NE <span class="opt">=&gt; (</span><span class="kwa">self</span><span class="opt">.</span>y<span class="opt">%</span><span class="num">2</span> <span class="opt">-</span> <span class="num">1</span><span class="opt">,</span>  <span class="num">1</span><span class="opt">),</span>
                <span class="opt">&amp;</span>NW <span class="opt">=&gt; (</span><span class="kwa">self</span><span class="opt">.</span>y<span class="opt">%</span><span class="num">2</span>    <span class="opt">,</span>  <span class="num">1</span><span class="opt">),</span>
                <span class="opt">&amp;</span>SE <span class="opt">=&gt; (</span><span class="kwa">self</span><span class="opt">.</span>y<span class="opt">%</span><span class="num">2</span> <span class="opt">-</span> <span class="num">1</span><span class="opt">, -</span><span class="num">1</span><span class="opt">),</span>
                <span class="opt">&amp;</span>SW <span class="opt">=&gt; (</span><span class="kwa">self</span><span class="opt">.</span>y<span class="opt">%</span><span class="num">2</span>    <span class="opt">, -</span><span class="num">1</span><span class="opt">)</span>
            <span class="opt">};</span>

        <span class="kwa">let</span> new_position <span class="opt">=</span> <span class="kwa">self</span><span class="num">.i</span>n<span class="num">_2</span>d<span class="num">_</span>d<span class="num">i</span>rect<span class="num">i</span>on<span class="opt">(</span>dx<span class="opt">,</span> dy<span class="opt">);</span>

        <span class="kwa">if</span> Position<span class="opt">::</span><span class="kwd">is_valid</span><span class="opt">(&amp;</span>new_position<span class="opt">) {</span>
            <span class="kwd">Some</span><span class="opt">(</span>new_position<span class="opt">.</span><span class="kwd">clone</span><span class="opt">())</span>
        <span class="opt">}</span> <span class="kwa">else</span> <span class="opt">{</span>
            None
        <span class="opt">}</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">in_2d_direction</span><span class="opt">(&amp;</span><span class="kwa">self</span><span class="opt">,</span> dx <span class="opt">:</span> <span class="kwb">isize</span><span class="opt">,</span> dy <span class="opt">:</span> <span class="kwb">isize</span><span class="opt">) -&gt;</span> Position <span class="opt">{</span>
        Position <span class="opt">{</span>
            x<span class="opt">:</span> <span class="kwa">self</span><span class="opt">.</span>x <span class="opt">+</span> dx<span class="opt">,</span>
            y<span class="opt">:</span> <span class="kwa">self</span><span class="opt">.</span>y <span class="opt">+</span> dy
        <span class="opt">}</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">is_valid</span><span class="opt">(&amp;</span>Position<span class="opt">{</span>x<span class="opt">,</span>y<span class="opt">} : &amp;</span>Position<span class="opt">) -&gt;</span> bool <span class="opt">{</span>
        <span class="num">0</span> <span class="opt">&lt;=</span> x <span class="opt">&amp;&amp;</span> x <span class="opt">&lt;</span> WIDTH <span class="kwa">as</span> <span class="kwb">isize</span> <span class="opt">&amp;&amp;</span> <span class="num">0</span> <span class="opt">&lt;=</span> y <span class="opt">&amp;&amp;</span> y <span class="opt">&lt;</span> HEIGHT <span class="kwa">as</span> <span class="kwb">isize</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">to_mask</span><span class="opt">(&amp;</span><span class="kwa">self</span><span class="opt">) -&gt;</span> <span class="kwb">u64</span> <span class="opt">{</span>
        <span class="num">1u64</span> <span class="opt">&lt;&lt; (</span><span class="kwa">self</span><span class="opt">.</span>y <span class="opt">*</span> WIDTH <span class="kwa">as</span> <span class="kwb">isize</span> <span class="opt">+</span> <span class="kwa">self</span><span class="opt">.</span>x<span class="opt">)</span> <span class="kwa">as</span> <span class="kwb">usize</span>
    <span class="opt">}</span>
<span class="opt">}</span>

<span class="kwa">use</span> Direction<span class="opt">::*;</span>

<span class="ppc">#[derive(Clone)]</span>
<span class="kwa">enum</span> Direction <span class="opt">{</span>
    E<span class="opt">=</span><span class="num">0</span><span class="opt">,</span> SE<span class="opt">=</span><span class="num">1</span><span class="opt">,</span> SW<span class="opt">=</span><span class="num">2</span><span class="opt">,</span> W<span class="opt">=</span><span class="num">3</span><span class="opt">,</span> NW<span class="opt">=</span><span class="num">4</span><span class="opt">,</span> NE<span class="opt">=</span><span class="num">5</span>
<span class="opt">}</span>

<span class="kwa">impl</span> Direction <span class="opt">{</span>
    <span class="kwa">fn</span> <span class="kwd">rotate</span><span class="opt">(&amp;</span><span class="kwa">self</span><span class="opt">) -&gt;</span> Direction <span class="opt">{</span>
        <span class="kwa">self</span><span class="opt">.</span><span class="kwd">as_modified</span><span class="opt">(|</span>x<span class="opt">| (</span>x <span class="opt">+</span> <span class="num">1</span><span class="opt">)%</span><span class="num">6</span><span class="opt">)</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">flip</span><span class="opt">(&amp;</span><span class="kwa">self</span><span class="opt">) -&gt;</span> Direction <span class="opt">{</span>
        <span class="kwa">self</span><span class="opt">.</span><span class="kwd">as_modified</span><span class="opt">(|</span>x<span class="opt">| (</span><span class="num">9</span> <span class="opt">-</span> x<span class="opt">)%</span><span class="num">6</span><span class="opt">)</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> <span class="kwd">from_int</span><span class="opt">(</span>value <span class="opt">:</span> <span class="kwb">isize</span><span class="opt">) -&gt;</span> Option<span class="opt">&lt;</span>Direction<span class="opt">&gt; {</span>
        <span class="kwa">match</span> value <span class="opt">{</span>
            <span class="num">0</span> <span class="opt">=&gt;</span> <span class="kwd">Some</span><span class="opt">(</span>E<span class="opt">),</span>
            <span class="num">1</span> <span class="opt">=&gt;</span> <span class="kwd">Some</span><span class="opt">(</span>SE<span class="opt">),</span>
            <span class="num">2</span> <span class="opt">=&gt;</span> <span class="kwd">Some</span><span class="opt">(</span>SW<span class="opt">),</span>
            <span class="num">3</span> <span class="opt">=&gt;</span> <span class="kwd">Some</span><span class="opt">(</span>W<span class="opt">),</span>
            <span class="num">4</span> <span class="opt">=&gt;</span> <span class="kwd">Some</span><span class="opt">(</span>NW<span class="opt">),</span>
            <span class="num">5</span> <span class="opt">=&gt;</span> <span class="kwd">Some</span><span class="opt">(</span>NE<span class="opt">),</span>
            _ <span class="opt">=&gt;</span> None<span class="opt">,</span>
        <span class="opt">}</span>
    <span class="opt">}</span>

    <span class="kwa">fn</span> as_modified<span class="opt">&lt;</span>F <span class="opt">:</span> <span class="kwd">Fn</span><span class="opt">(</span><span class="kwb">isize</span><span class="opt">) -&gt;</span> <span class="kwb">isize</span><span class="opt">&gt;(&amp;</span><span class="kwa">self</span><span class="opt">,</span> modifier <span class="opt">:</span> F<span class="opt">) -&gt;</span> Direction <span class="opt">{</span>
        Direction<span class="opt">::</span><span class="kwd">from_int</span><span class="opt">(</span><span class="kwd">modifier</span><span class="opt">(</span><span class="kwa">self</span><span class="opt">.</span><span class="kwd">clone</span><span class="opt">()</span> <span class="kwa">as</span> <span class="kwb">isize</span><span class="opt">))</span><span class="num">.u</span>nwrap<span class="opt">()</span>
    <span class="opt">}</span>
<span class="opt">}</span>

<span class="kwa">fn</span> <span class="kwd">no_islands</span><span class="opt">(</span>mask <span class="opt">:</span> <span class="kwb">u64</span><span class="opt">) -&gt;</span> bool <span class="opt">{</span>
    <span class="kwa">let</span> allowed <span class="opt">= !</span>mask <span class="opt">&amp;</span> FULL_MASK<span class="opt">;</span>
    <span class="kwa">let</span> seed <span class="opt">= (</span><span class="num">1</span> <span class="opt">&lt;&lt;</span> mask<span class="opt">.</span><span class="kwd">trailing_zeros</span><span class="opt">()</span> <span class="kwa">as</span> <span class="kwb">usize</span><span class="opt">) -</span> <span class="num">1</span><span class="opt">;</span>
    <span class="kwa">let</span> filled <span class="opt">=</span> <span class="kwd">flood_fill</span><span class="opt">(</span>seed<span class="opt">,</span> allowed<span class="opt">);</span>
    filled<span class="opt">.</span><span class="kwd">count_ones</span><span class="opt">() %</span> <span class="num">5</span> <span class="opt">==</span> <span class="num">0</span>
<span class="opt">}</span>

<span class="kwa">fn</span> <span class="kwd">flood_fill</span><span class="opt">(</span>seed <span class="opt">:</span> <span class="kwb">u64</span><span class="opt">,</span> allowed <span class="opt">:</span> <span class="kwb">u64</span><span class="opt">) -&gt;</span> <span class="kwb">u64</span> <span class="opt">{</span>
    <span class="kwa">let mut</span> filled <span class="opt">=</span> seed<span class="opt">;</span>

    <span class="kwa">loop</span> <span class="opt">{</span>
        <span class="kwa">let</span> new_filled <span class="opt">=</span> <span class="kwd">grow</span><span class="opt">(</span>filled<span class="opt">) &amp;</span> allowed<span class="opt">;</span>
        <span class="kwa">if</span> new_filled <span class="opt">==</span> filled <span class="opt">{</span>
            <span class="kwa">return</span> filled<span class="opt">;</span>
        <span class="opt">}</span>
        filled <span class="opt">=</span> new_filled<span class="opt">;</span>
    <span class="opt">}</span>
<span class="opt">}</span>

<span class="kwa">fn</span> <span class="kwd">find_first_one</span><span class="opt">(</span>mask <span class="opt">:</span> <span class="kwb">u64</span><span class="opt">) -&gt;</span> <span class="kwb">usize</span> <span class="opt">{</span>
    <span class="num">63</span> <span class="opt">-</span> mask<span class="opt">.</span><span class="kwd">leading_zeros</span><span class="opt">()</span> <span class="kwa">as</span> <span class="kwb">usize</span>
<span class="opt">}</span>

<span class="kwa">fn</span> <span class="kwd">overlaps</span><span class="opt">(</span>m1 <span class="opt">:</span> <span class="kwb">u64</span><span class="opt">,</span> m2 <span class="opt">:</span> <span class="kwb">u64</span><span class="opt">) -&gt;</span> bool <span class="opt">{</span>
    <span class="kwa">return</span> m1 <span class="opt">&amp;</span> m2 <span class="opt">!=</span> <span class="num">0u64</span><span class="opt">;</span>
<span class="opt">}</span>

<span class="kwa">fn</span> <span class="kwd">grow</span><span class="opt">(</span>mask <span class="opt">:</span> <span class="kwb">u64</span><span class="opt">) -&gt;</span> <span class="kwb">u64</span> <span class="opt">{</span>
    <span class="kwa">let</span> even <span class="opt">=</span> <span class="num">0b00000_11111_00000_11111_00000_11111_00000_11111_00000_11111</span><span class="opt">;</span>
    <span class="kwa">let</span> odd <span class="opt">=</span> <span class="num">0b11111_00000_11111_00000_11111_00000_11111_00000_11111_00000</span><span class="opt">;</span>
    <span class="kwa">let</span> right <span class="opt">=</span> <span class="num">0b00001_00001_00001_00001_00001_00001_00001_00001_00001_00001</span><span class="opt">;</span>
    <span class="kwa">let</span> left <span class="opt">=</span> <span class="num">0b10000_10000_10000_10000_10000_10000_10000_10000_10000_10000</span><span class="opt">;</span>

    <span class="kwa">let</span> not_right <span class="opt">=</span> mask <span class="opt">&amp; !</span>right<span class="opt">;</span>
    <span class="kwa">let</span> not_left <span class="opt">=</span> mask <span class="opt">&amp; !</span>left<span class="opt">;</span>
    <span class="kwa">let</span> east <span class="opt">=</span> not_right<span class="opt">&gt;&gt;</span><span class="num">1</span><span class="opt">;</span>
    <span class="kwa">let</span> west <span class="opt">=</span> not_left<span class="opt">&lt;&lt;</span><span class="num">1</span><span class="opt">;</span>
    <span class="kwa">let</span> body <span class="opt">=</span> mask <span class="opt">| (</span>east <span class="opt">&amp; (</span>even<span class="opt">&gt;&gt;</span><span class="num">1</span><span class="opt">)) | (</span>west <span class="opt">&amp; (</span>odd<span class="opt">&lt;&lt;</span><span class="num">1</span><span class="opt">));</span>

    mask <span class="opt">|</span> west <span class="opt">| (</span>body <span class="opt">&lt;&lt;</span> WIDTH<span class="opt">) |</span> east <span class="opt">| (</span>body <span class="opt">&gt;&gt;</span> WIDTH<span class="opt">)</span>
<span class="opt">}</span>


<span class="kwa">const</span> NUM_PIECES <span class="opt">:</span> <span class="kwb">usize</span> <span class="opt">=</span> <span class="num">10</span><span class="opt">;</span>
<span class="kwa">const</span> WIDTH <span class="opt">:</span> <span class="kwb">usize</span> <span class="opt">=</span> <span class="num">5</span><span class="opt">;</span>
<span class="kwa">const</span> HEIGHT <span class="opt">:</span> <span class="kwb">usize</span> <span class="opt">=</span> <span class="num">10</span><span class="opt">;</span>
<span class="kwa">const</span> NUM_POSITIONS <span class="opt">:</span> <span class="kwb">usize</span> <span class="opt">=</span> WIDTH<span class="opt">*</span>HEIGHT<span class="opt">;</span>
<span class="kwa">const</span> LAST_POSITION <span class="opt">:</span> <span class="kwb">usize</span> <span class="opt">=</span> NUM_POSITIONS<span class="opt">-</span><span class="num">1</span><span class="opt">;</span>
<span class="kwa">const</span> FULL_MASK <span class="opt">:</span> <span class="kwb">u64</span> <span class="opt">= (</span><span class="num">1</span> <span class="opt">&lt;&lt;</span> NUM_POSITIONS<span class="opt">) -</span> <span class="num">1</span><span class="opt">;</span>
    </pre>
  </section>
  <section>
    <h3 id="log">notes, command-line, and program output</h3>
    <pre>
NOTES:
64-bit Ubuntu quad core
rustc 1.25.0 (84203cac6 2018-03-25)


Thu, 29 Mar 2018 17:00:39 GMT

MAKE:
/opt/src/rust-1.25.0/bin/rustc -C opt-level=3 -C target-cpu=core2 -C lto -C codegen-units=1  meteor.rs -o meteor.rust-2.rust_run
warning: unnecessary parentheses around `for` head expression
  --&gt; meteor.rs:85:24
   |
85 |     for first_piece in (0..NUM_PIECES) {
   |                        ^^^^^^^^^^^^^^^ help: remove these parentheses
   |
   = note: #[warn(unused_parens)] on by default

warning: unnecessary parentheses around `for` head expression
  --&gt; meteor.rs:88:25
   |
88 |         for mask_idx in (0..num_masks) {
   |                         ^^^^^^^^^^^^^^ help: remove these parentheses

warning: unnecessary parentheses around `for` head expression
   --&gt; meteor.rs:208:25
    |
208 |         for position in (0..NUM_POSITIONS) {
    |                         ^^^^^^^^^^^^^^^^^^ help: remove these parentheses

warning: unnecessary parentheses around `for` head expression
   --&gt; meteor.rs:218:22
    |
218 |         for piece in (0..NUM_PIECES) {
    |                      ^^^^^^^^^^^^^^^ help: remove these parentheses

warning: unnecessary parentheses around `for` head expression
   --&gt; meteor.rs:253:18
    |
253 |         for i in (0..NUM_POSITIONS) {
    |                  ^^^^^^^^^^^^^^^^^^ help: remove these parentheses

warning: unnecessary parentheses around `for` head expression
   --&gt; meteor.rs:327:18
    |
327 |         for _ in (0..num_orientations) {
    |                  ^^^^^^^^^^^^^^^^^^^^^ help: remove these parentheses

warning: unnecessary parentheses around `for` head expression
   --&gt; meteor.rs:328:22
    |
328 |             for _ in (0..num_rotations) {
    |                      ^^^^^^^^^^^^^^^^^^ help: remove these parentheses

warning: unnecessary parentheses around `for` head expression
   --&gt; meteor.rs:329:26
    |
329 |                 for x in (0..WIDTH as isize) {
    |                          ^^^^^^^^^^^^^^^^^^^ help: remove these parentheses

warning: unnecessary parentheses around `for` head expression
   --&gt; meteor.rs:330:30
    |
330 |                     for y in (0..HEIGHT as isize) {
    |                              ^^^^^^^^^^^^^^^^^^^^ help: remove these parentheses


7.74s to complete and log all make actions

COMMAND LINE:
./meteor.rust-2.rust_run 2098

PROGRAM OUTPUT:
2098 solutions found

0 0 0 0 1 
 2 2 2 0 1 
2 6 6 1 1 
 2 6 1 5 5 
8 6 5 5 5 
 8 6 3 3 3 
4 8 8 9 3 
 4 4 8 9 3 
4 7 4 7 9 
 7 7 7 9 9 

9 9 9 9 8 
 9 6 6 8 5 
6 6 8 8 5 
 6 8 2 5 5 
7 7 7 2 5 
 7 4 7 2 0 
1 4 2 2 0 
 1 4 4 0 3 
1 4 0 0 3 
 1 1 3 3 3 

    </pre>
  </section>
</article>
<footer>
  <nav>
    <ul>
      <li><a href="./license.html"><span>license</span></a>
    </ul>
  </nav>
</footer>

